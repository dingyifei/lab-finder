# Story 6.1: mcp-linkedin MCP Server Integration

## Status

**Draft**

## Story

**As a** user,
**I want** mcp-linkedin MCP server integrated for LinkedIn access,
**so that** I can match lab members to LinkedIn profiles efficiently.

## Acceptance Criteria

1. mcp-linkedin MCP server configured and connected (from Story 1.5)
2. LinkedIn authentication managed by MCP server (not application code)
3. Search people and get profile tools available
4. Session managed by MCP server automatically
5. Graceful handling if MCP server unavailable
6. Rate limiting managed by MCP server internally
7. Progress tracking for LinkedIn operations

## Tasks / Subtasks

- [ ] **Task 1: Verify mcp-linkedin MCP Server Setup** (AC: 1, 2)
  - [ ] Confirm mcp-linkedin installed (from Story 1.5)
  - [ ] Verify LinkedIn credentials configured in MCP server
  - [ ] Test connectivity to MCP server
  - [ ] Log: "mcp-linkedin connected successfully"

- [ ] **Task 2: Create LinkedIn Agent** (AC: 3)
  - [ ] Create `src/agents/linkedin_matcher.py`
  - [ ] Use mcp_client.py from Story 1.5
  - [ ] Implement:
    - `search_linkedin_profile(name, university)`
    - `get_profile_details(profile_url)`

- [ ] **Task 3: Implement LinkedIn Profile Search** (AC: 3)
  - [ ] Use mcp-linkedin `search_people` tool
  - [ ] Search by name + university filters
  - [ ] Return candidate profiles

- [ ] **Task 4: Handle MCP Server Unavailability** (AC: 5)
  - [ ] Catch MCP connection errors
  - [ ] Flag members with "mcp_server_unavailable"
  - [ ] Continue processing without LinkedIn data
  - [ ] Log: "LinkedIn matching skipped - MCP server unavailable"

- [ ] **Task 5: Integrate Progress Tracking** (AC: 7)
  - [ ] Display: "Phase 5: LinkedIn Matching [X/Y members]"

## Dev Notes

### Source Tree Location
- Create: `src/agents/linkedin_matcher.py`
- Use: `src/utils/mcp_client.py` (from Story 1.5)
- Use: `src/utils/logger.py` (from Story 1.7)
- Use: `src/utils/progress_tracker.py` (from Story 1.7)
- Modify: `src/models/lab_member.py` (created in Story 6.3)

**Architecture Note:** Uses mcp-linkedin MCP server (NOT Playwright queue). The MCP server handles:
- LinkedIn authentication
- Session management
- Rate limiting
- Credential storage

### MCP Client API Summary (from Story 1.5)

**Key Functions from `src/utils/mcp_client.py`:**

1. **`search_linkedin_profile(name: str, university: str) -> list[dict]`**
   - Searches LinkedIn using mcp-linkedin `search_people` tool
   - Returns list of candidate profiles with basic info
   - Timeout: 30 seconds
   - Automatic retry: 3 attempts with exponential backoff

2. **`get_profile_details(profile_url: str) -> dict`**
   - Retrieves full profile details using mcp-linkedin `get_profile` tool
   - Returns complete profile data (education, experience, etc.)
   - Timeout: 30 seconds
   - Automatic retry: 3 attempts with exponential backoff

**MCP Server Error Responses:**
- Connection errors: `MCPConnectionError` exception
- Rate limiting: `MCPRateLimitError` exception (handled by MCP server internally)
- Timeout: `asyncio.TimeoutError` after 30 seconds

**MCP Usage Pattern:**
```python
from src.utils.mcp_client import search_linkedin_profile, get_profile_details
from src.utils.logger import get_logger

logger = get_logger(correlation_id=run_id, phase="linkedin_matching", component="linkedin_matcher")

try:
    profiles = await search_linkedin_profile(
        name=member.name,
        university=university_name
    )
    logger.info("LinkedIn search complete", member=member.name, results_count=len(profiles))
except MCPConnectionError as e:
    logger.error("MCP server unavailable", error=str(e))
    # Flag member and continue
```

### Data Quality Flags

**Where Flags Are Stored:** `LabMember.data_quality_flags: list[str]` (from Story 6.3)

**Flags Used in This Story:**
- `"mcp_server_unavailable"` - MCP server connection failed (consistent with Story 6.5)
- `"linkedin_match_failed"` - LinkedIn search succeeded but matching failed

**Example:**
```python
from src.models.lab_member import LabMember

member = LabMember(name="Jane Doe", data_quality_flags=["mcp_server_unavailable"])
```

### Progress Tracking Integration

**Use `progress_tracker.py` from Story 1.7:**

```python
from src.utils.progress_tracker import ProgressTracker

tracker = ProgressTracker()
tracker.start_phase("LinkedIn Matching", total_items=len(lab_members))

for i, member in enumerate(lab_members):
    # Match member to LinkedIn
    tracker.update(completed=i+1)

tracker.complete_phase()
```

**Expected Display:**
```
Phase 6: LinkedIn Matching [3/25 members]
```

### Testing

**Test File Location:** `tests/unit/test_linkedin_matcher.py`, `tests/integration/test_mcp_linkedin.py`

**Test Approach:** Unit tests (mock MCP) + Integration tests (real MCP server)

**Key Test Scenarios:**

1. **MCP Connectivity Test** (Integration)
   - Verify mcp-linkedin server is reachable
   - Test basic `search_people` query
   - Assert non-empty response

2. **Profile Search Success** (Unit)
   - Mock `search_linkedin_profile()` to return sample profiles
   - Call `linkedin_matcher.search_for_member()`
   - Assert profiles returned correctly

3. **MCP Server Unavailable** (Unit)
   - Mock `search_linkedin_profile()` to raise `MCPConnectionError`
   - Verify `data_quality_flags` contains `"mcp_server_unavailable"`
   - Assert processing continues without crash

4. **Progress Tracking** (Unit)
   - Mock progress tracker
   - Process multiple members
   - Verify `update()` called for each member

**Success Criteria:**
- All MCP connection tests pass with real mcp-linkedin server running
- Error handling prevents crashes when MCP unavailable
- Data quality flags correctly added to LabMember objects
- Progress tracking displays correct member counts

**Test Data Requirements:**
- Mock MCP responses with sample LinkedIn profile data
- Sample LabMember objects for testing

**Example Test Pattern:**
```python
import pytest
from unittest.mock import AsyncMock, patch
from src.agents.linkedin_matcher import LinkedInMatcher
from src.models.lab_member import LabMember

@pytest.mark.asyncio
async def test_mcp_unavailable_flags_member():
    # Arrange
    matcher = LinkedInMatcher()
    member = LabMember(name="John Doe")

    with patch('src.utils.mcp_client.search_linkedin_profile') as mock_search:
        mock_search.side_effect = MCPConnectionError("Server unavailable")

        # Act
        result = await matcher.match_member(member)

        # Assert
        assert "mcp_server_unavailable" in result.data_quality_flags
        assert result.linkedin_url is None
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-06 | 0.2 | Added MCP client API summary, testing guidance, data quality flags clarification, progress tracking details | Sarah (PO) |
| 2025-10-06 | 0.3 | Fixed flag consistency: linkedin_unavailable â†’ mcp_server_unavailable (aligns with Story 6.5) | Sarah (PO) |
