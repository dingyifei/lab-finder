# Story 6.1: mcp-linkedin MCP Server Integration

## Status

**Draft**

## Story

**As a** user,
**I want** mcp-linkedin MCP server integrated for LinkedIn access,
**so that** I can match lab members to LinkedIn profiles efficiently.

## Acceptance Criteria

1. mcp-linkedin MCP server configured and connected (from Story 1.5)
2. LinkedIn authentication managed by MCP server (not application code)
3. Search people and get profile tools available
4. Session managed by MCP server automatically
5. Graceful handling if MCP server unavailable (NFR13)
6. Rate limiting managed by MCP server internally (NFR11)
7. Progress tracking for LinkedIn operations (NFR17)
8. Missing LinkedIn data handled gracefully (NFR13)
9. Profile access failures logged appropriately (NFR17)
10. Analysis continues with partial LinkedIn data if needed
11. Error summary generated with match statistics

## Tasks / Subtasks

- [ ] **Task 1: Verify mcp-linkedin MCP Server Setup** (AC: 1, 2)
  - [ ] Confirm mcp-linkedin installed (from Story 1.5)
  - [ ] Verify LinkedIn credentials configured in MCP server
  - [ ] Test connectivity to MCP server
  - [ ] Log: "mcp-linkedin connected successfully"

- [ ] **Task 2: Create LinkedIn Agent with AgentDefinition** (AC: 3)
  - [ ] Create `src/agents/linkedin_matcher.py`
  - [ ] Use `get_mcp_server_config()` from Story 1.5 to configure Claude Agent SDK
  - [ ] Define AgentDefinition with tools:
    - `mcp__linkedin__search_people` - Search profiles by name + university
    - `mcp__linkedin__get_profile` - Get profile details
  - [ ] MCP server spawned automatically by SDK via STDIO - no manual implementation needed

- [ ] **Task 3: Configure LinkedIn Profile Search in Agent Prompt** (AC: 3)
  - [ ] Agent prompt instructs use of `mcp__linkedin__search_people` tool
  - [ ] Pass name + university as search parameters
  - [ ] SDK handles tool invocation and returns candidate profiles
  - [ ] No manual search implementation needed - specified in AgentDefinition prompt

- [ ] **Task 4: Handle MCP Server Unavailability** (AC: 5)
  - [ ] Catch MCP connection errors
  - [ ] Flag members with "mcp_server_unavailable"
  - [ ] Continue processing without LinkedIn data
  - [ ] Log: "LinkedIn matching skipped - MCP server unavailable"

- [ ] **Task 5: Integrate Progress Tracking** (AC: 7)
  - [ ] Display: "Phase 6: LinkedIn Matching [X/Y members]"
  - [ ] Update progress as each member is processed
  - [ ] Show real-time status: "Processing member X of Y"

- [ ] **Task 6: Handle Missing/Incomplete LinkedIn Data** (AC: 4, 6)
  - [ ] Handle empty search results (no LinkedIn profile found)
  - [ ] Handle incomplete profiles (missing education section)
  - [ ] Parse entry year from LinkedIn education data with error handling
  - [ ] Gracefully handle unparseable dates or missing fields
  - [ ] Never crash on missing data - continue pipeline with flags

- [ ] **Task 7: Assign Data Quality Flags** (AC: 2, 5)
  - [ ] Flag "no_linkedin_profile" when search returns empty results
  - [ ] Flag "incomplete_linkedin_data" when profile missing education
  - [ ] Flag "missing_entry_year" when entry date unparseable
  - [ ] Flag "mcp_server_unavailable" when MCP server connection fails
  - [ ] All flags stored in LabMember.data_quality_flags list

- [ ] **Task 8: Implement Error Summary Reporting** (AC: 3, 7)
  - [ ] Count successful matches vs. failures
  - [ ] Categorize failures by flag type
  - [ ] Generate summary: "LinkedIn: 18/25 matched (72%), 5 no profile, 2 MCP errors"
  - [ ] Log summary at INFO level with correlation ID
  - [ ] Include summary in phase completion checkpoint

## Dev Notes

### Source Tree Location
- Create: `src/agents/linkedin_matcher.py`
- Use: `src/utils/mcp_client.py` (from Story 1.5)
- Use: `src/utils/logger.py` (from Story 1.7)
- Use: `src/utils/progress_tracker.py` (from Story 1.7)
- Modify: `src/models/lab_member.py` (created in Story 6.2)

**Architecture Note:** Uses mcp-linkedin MCP server (NOT Playwright queue). The MCP server handles:
- LinkedIn authentication
- Session management
- Rate limiting
- Credential storage

### MCP Configuration (from Story 1.5)

**⚠️ CRITICAL ARCHITECTURE UPDATE (2025-10-06):**
Story 1.5 creates a **configuration helper**, not a wrapper with manual functions. Claude Agent SDK handles all MCP communication.

**Configuration Helper from `src/utils/mcp_client.py`:**

```python
def get_mcp_server_config() -> dict:
    """Return MCP server configuration for Claude Agent SDK"""
    return {
        "linkedin": {
            "type": "stdio",
            "command": "uvx",
            "args": ["--from", "git+https://github.com/adhikasp/mcp-linkedin", "mcp-linkedin"],
            "env": {
                "LINKEDIN_EMAIL": os.getenv("LINKEDIN_EMAIL"),
                "LINKEDIN_PASSWORD": os.getenv("LINKEDIN_PASSWORD")
            }
        }
    }
```

**MCP Tools Available (via Claude Agent SDK):**
1. **`mcp__linkedin__search_people`** - Search profiles by name + filters
2. **`mcp__linkedin__get_profile`** - Get full profile details by URL

**SDK handles automatically:**
- Server spawning via STDIO
- Tool invocation
- Retry logic and timeouts
- Error handling

**Agent Usage Pattern (Claude Agent SDK):**
```python
from src.utils.mcp_client import get_mcp_server_config
from claude_agent_sdk import ClaudeAgentOptions, AgentDefinition

# Configure SDK with MCP server
mcp_config = get_mcp_server_config()
options = ClaudeAgentOptions(
    mcp_servers=mcp_config,
    allowed_tools=["mcp__linkedin__search_people", "mcp__linkedin__get_profile"]
)

# Define agent with MCP tools
linkedin_matcher = AgentDefinition(
    description="Matches lab members to LinkedIn profiles",
    prompt=f"""Match lab member to LinkedIn:
    Member: {member.name}
    University: {university_name}

    Steps:
    1. Use mcp__linkedin__search_people to search
    2. LLM-match best profile
    3. Use mcp__linkedin__get_profile for details
    """,
    tools=["mcp__linkedin__search_people", "mcp__linkedin__get_profile"],
    model="sonnet"
)

# SDK handles server spawning and tool execution
```

### Data Quality Flags

**Where Flags Are Stored:** `LabMember.data_quality_flags: list[str]` (from Story 6.2)

**Flags Used in This Story:**
- `"mcp_server_unavailable"` - MCP server connection failed
- `"no_linkedin_profile"` - Search returned empty results (no profile found)
- `"incomplete_linkedin_data"` - Profile exists but missing education section
- `"missing_entry_year"` - Entry year could not be parsed from education data
- `"linkedin_match_failed"` - LinkedIn search succeeded but LLM matching failed

**Example:**
```python
from src.models.lab_member import LabMember

member = LabMember(name="Jane Doe", data_quality_flags=["no_linkedin_profile"])
```

### Error Handling Patterns

**Missing Data Handling:**
```python
def parse_entry_year(profile: dict, member_name: str, logger) -> Optional[int]:
    """
    Parse entry year from LinkedIn profile with error handling.

    Returns:
        Entry year as int, or None if not found/unparseable
    """
    try:
        education = profile.get('education', [])

        if not education:
            logger.warning("LinkedIn profile missing education section", member=member_name)
            return None

        # Find PhD entry
        for edu in education:
            if 'PhD' in edu.get('degree', ''):
                start_date = edu.get('start_date', '')

                import re
                year_match = re.search(r'\d{4}', str(start_date))

                if year_match:
                    return int(year_match.group(0))

        logger.warning("Could not find PhD entry year", member=member_name)
        return None

    except (KeyError, ValueError, TypeError) as e:
        logger.warning("Error parsing entry year", member=member_name, error=str(e))
        return None
```

**Error Summary Generation:**
```python
from collections import Counter

def generate_linkedin_summary(members: list[LabMember]) -> dict:
    """Generate summary of LinkedIn matching results."""
    total = len(members)
    matched = sum(1 for m in members if m.linkedin_url is not None)

    # Count data quality flags
    all_flags = [flag for m in members for flag in m.data_quality_flags]
    flag_counts = Counter(all_flags)

    summary = {
        "total_members": total,
        "matched": matched,
        "match_rate": round(matched / total * 100, 1) if total > 0 else 0,
        "no_profile": flag_counts.get("no_linkedin_profile", 0),
        "mcp_errors": flag_counts.get("mcp_server_unavailable", 0),
        "incomplete_data": flag_counts.get("incomplete_linkedin_data", 0),
    }

    logger.info("LinkedIn matching summary", **summary)
    return summary
```

### Progress Tracking Integration

**Use `progress_tracker.py` from Story 1.7:**

```python
from src.utils.progress_tracker import ProgressTracker

tracker = ProgressTracker()
tracker.start_phase("LinkedIn Matching", total_items=len(lab_members))

for i, member in enumerate(lab_members):
    # Match member to LinkedIn
    tracker.update(completed=i+1)

tracker.complete_phase()
```

**Expected Display:**
```
Phase 6: LinkedIn Matching [3/25 members]
```

### Testing

**Test File Location:** `tests/unit/test_linkedin_matcher.py`, `tests/integration/test_mcp_linkedin.py`

**Test Approach:** Unit tests (mock MCP) + Integration tests (real MCP server)

**Key Test Scenarios:**

1. **MCP Connectivity Test** (Integration)
   - Verify mcp-linkedin server is reachable
   - Test basic `search_people` query
   - Assert non-empty response

2. **Profile Search Success** (Unit)
   - Mock MCP SDK response to return sample profiles
   - Verify profiles processed correctly via AgentDefinition
   - Assert member matched with confidence score

3. **MCP Server Unavailable** (Unit)
   - Mock MCP SDK to indicate server unavailable
   - Verify `data_quality_flags` contains `"mcp_server_unavailable"`
   - Assert processing continues without crash

4. **Missing LinkedIn Profile** (Unit)
   - Mock MCP SDK to return empty results
   - Verify flag `"no_linkedin_profile"` assigned
   - Assert INFO log created (not error - normal case)

5. **Incomplete Profile Data** (Unit)
   - Mock LinkedIn profile with no education section
   - Call `parse_entry_year()`
   - Assert `None` returned and `"incomplete_linkedin_data"` flag set
   - Verify WARNING log created

6. **Error Summary Generation** (Unit)
   - Create 5 members: 3 matched, 1 no profile, 1 MCP error
   - Call `generate_linkedin_summary()`
   - Assert summary: total=5, matched=3, match_rate=60%, no_profile=1, mcp_errors=1

7. **Progress Tracking** (Unit)
   - Mock progress tracker
   - Process multiple members
   - Verify `update()` called for each member

**Success Criteria:**
- All MCP connection tests pass with real mcp-linkedin server running
- Error handling prevents crashes when MCP unavailable
- Data quality flags correctly added to LabMember objects
- Progress tracking displays correct member counts

**Test Data Requirements:**
- Mock MCP responses with sample LinkedIn profile data
- Sample LabMember objects for testing

**Example Test Pattern:**
```python
import pytest
from unittest.mock import AsyncMock, patch
from src.agents.linkedin_matcher import LinkedInMatcher
from src.models.lab_member import LabMember

@pytest.mark.asyncio
async def test_mcp_unavailable_flags_member():
    # Arrange
    matcher = LinkedInMatcher()
    member = LabMember(name="John Doe")

    with patch('src.utils.mcp_client.search_linkedin_profile') as mock_search:
        mock_search.side_effect = MCPConnectionError("Server unavailable")

        # Act
        result = await matcher.match_member(member)

        # Assert
        assert "mcp_server_unavailable" in result.data_quality_flags
        assert result.linkedin_url is None
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-06 | 0.2 | Added MCP client API summary, testing guidance, data quality flags clarification, progress tracking details | Sarah (PO) |
| 2025-10-06 | 0.3 | Fixed flag consistency: linkedin_unavailable → mcp_server_unavailable (aligns with Story 6.5) | Sarah (PO) |
| 2025-10-06 | 0.4 | Updated with SDK-based MCP usage pattern (configuration helper, not manual wrapper functions) | Bob (SM) |
| 2025-10-06 | 0.5 | Merged Story 6.5 (error handling) content: Added Tasks 6-8 for missing data handling, data quality flags, error summary. Story 6.2 removed, 6.3→6.2, 6.4→6.3. Updated AC 8-11. See ARCHITECTURE-ERRATA Issue #3 | Sarah (PO) |
