# Story 8.2: Comparison Matrix for Top Labs

## Status

**Draft**

## Story

**As a** user,
**I want** a side-by-side comparison matrix of top-ranked labs,
**so that** I can easily compare key metrics across my best options.

## Acceptance Criteria

1. Comparison matrix generated for top N labs (configurable, default: top 10) (FR28)
2. Matrix columns: Lab, Fitness Score, Recent Publications, Position Availability, Website Status, Key Research Areas
3. Matrix formatted as markdown table in Overview.md
4. Metrics normalized for easy comparison
5. Visual indicators used where helpful (✓/✗ for position availability)
6. Matrix appears prominently in Overview.md

## Tasks / Subtasks

- [ ] **Task 1: Select Top N Labs** (AC: 1)
  - [ ] Get top 10 labs (or configured number)
  - [ ] Load all required metrics

- [ ] **Task 2: Build Comparison Matrix** (AC: 2, 4)
  - [ ] Create markdown table
  - [ ] Include key columns
  - [ ] Normalize metrics

- [ ] **Task 3: Add Visual Indicators** (AC: 5)
  - [ ] Use ✓/✗ for binary metrics
  - [ ] Use emoji for status indicators

- [ ] **Task 4: Insert into Overview.md** (AC: 3, 6)
  - [ ] Add matrix to report
  - [ ] Place prominently near top

## Dev Notes

### Source Tree Location
- Modify: `src/agents/report_generator.py`
- Modify: `output/Overview.md` (created in Story 8.1)

### Dependencies
- **Story 8.1 must complete first** - This story adds the comparison matrix to the Overview.md file created in 8.1

### Input Data
- Load from: `checkpoints/phase-7-fitness-scores.jsonl`
- Use top N labs from ranked list (configurable, default N=10)

### Metric Definitions
- **Lab:** PI name + department (e.g., "Dr. Smith - Bioengineering")
- **Fitness Score:** Overall score from Epic 7 (0-100 scale)
- **Recent Publications:** Count of publications from last 3 years (from Epic 5)
- **Position Availability:** Status from Epic 6 LinkedIn detection
  - ✓ = Graduating PhD(s) detected or recent departure
  - ✗ = No position signals detected
  - ? = LinkedIn data unavailable
- **Website Status:** Lab website freshness from Epic 4
  - Format: "Updated [date]" or "Last seen [date] (Archive.org)" or "❌ Unavailable"
- **Key Research Areas:** Top 3 research topics from lab website description or most common publication keywords

### Normalization Approach
- **Fitness Score:** Already normalized 0-100
- **Recent Publications:** Display raw count (no normalization needed for comparison)
- **Position Availability:** Binary indicator (✓/✗/?)
- **Website Status:** Display most recent date found
- **Key Research Areas:** Comma-separated text list

### Example Output Format
```markdown
| Lab | Fitness | Pubs | Position | Website | Research Areas |
|-----|---------|------|----------|---------|----------------|
| Dr. Smith - Bioengineering | 92 | 15 | ✓ | Updated 2024-09 | ML, Neural Networks, Brain-Computer Interfaces |
| Dr. Jones - Computer Science | 88 | 12 | ✗ | Updated 2024-11 | Distributed Systems, Cloud Computing, Databases |
```

## Testing

### Testing Approach
- **Unit Tests:** Matrix generation logic, metric extraction functions
- **Integration Tests:** Matrix insertion into Overview.md at correct location

### Key Test Scenarios
1. **Happy Path:** Top 10 labs with complete data, verify all metrics populated correctly
2. **Edge Case - Fewer than N labs:** Handle case where total labs < configured top N
3. **Edge Case - Tied Rankings:** Labs with identical fitness scores appear in consistent order
4. **Edge Case - Missing Metrics:** Handle labs with missing LinkedIn data, publications, or website
5. **Validation:** Verify matrix appears prominently in Overview.md (above full ranked list)
6. **Format Validation:** Markdown table renders correctly in viewers

### Success Criteria
- Matrix contains exactly top N labs matching fitness ranking from Story 8.1
- All required columns present with appropriate formatting
- Visual indicators (✓/✗/?) display correctly
- Matrix placed prominently near top of Overview.md

## References

### Related Documentation
- **PRD:** Epic 8 Comparison Matrix (docs/prd.md:820-832)
- **Architecture:** Report Generator component (docs/architecture.md:1307-1319)

### Dependencies
- **Story 8.1:** Overview.md creation (must complete first)
- **Epic 7:** Fitness scoring (provides ranked labs)
- **Epic 6:** LinkedIn Integration (provides position availability)
- **Epic 5:** Publications (provides publication counts)
- **Epic 4:** Lab Intelligence (provides website status)

### Data Sources
- Fitness scores: `checkpoints/phase-7-fitness-scores.jsonl`
- LinkedIn data: Lab object's `linkedin_matches` field
- Publications: Lab object's `publications` field
- Website status: Lab object's `website_last_updated` field

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
