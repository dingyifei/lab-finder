# Story 3.4: Filtered Professor Logging & Transparency

## Status

**Draft**

## Dependencies

**Must Be Complete Before Starting:**
- **Story 3.2**: LLM-Based Professor Research Field Filtering (provides Professor model with `is_filtered`, `filter_reasoning` fields)
- **Story 3.3**: Confidence Scoring for Filtering Decisions (provides `filter_confidence` field and borderline-professors.md report)
- **Story 3.1**: Multi-Agent Professor Discovery (provides professor records)
- **Story 1.4**: Shared Utilities (provides `checkpoint_manager`, `logger`)

## Story

**As a** user,
**I want** detailed logs of filtered-out professors with reasoning,
**so that** I can validate the system didn't miss relevant labs.

## Acceptance Criteria

1. All filtered professors logged with exclusion reasoning (FR13)
2. Log includes: professor name, department, research areas, confidence score, filter reason
3. Log saved to dedicated file (filtered-professors.md or similar)
4. Reasoning explains why research didn't align
5. User can review and manually add back professors if needed
6. Statistics provided: "Filtered X of Y professors (Z%)"

## Tasks / Subtasks

- [ ] **Task 1: Log All Filter Decisions to Structured Logger** (AC: 1, 2)
  - [ ] Use structlog from Story 1.7
  - [ ] Log every filter decision at INFO level
  - [ ] Log format:
    ```json
    {
      "component": "professor_filter",
      "professor_id": "prof-123",
      "professor_name": "Dr. John Doe",
      "department": "Literature",
      "school": "Arts & Sciences",
      "research_areas": ["Poetry", "Renaissance Literature"],
      "decision": "exclude",
      "is_filtered": false,
      "filter_confidence": 95,
      "filter_reasoning": "No overlap with user's bioengineering interests"
    }
    ```
  - [ ] Ensure correlation_id in all logs for traceability (passed from ProfessorFilterAgent initialization)

- [ ] **Task 2: Generate Filtered Professors Report with Detailed Reasoning** (AC: 3, 4)
  - [ ] Create `output/filtered-professors.md` markdown report
  - [ ] Structure:
    - Summary section with statistics
    - Table of excluded professors
    - Detailed reasoning for each excluded professor
  - [ ] For each excluded professor, provide comprehensive explanation:
    - What user research interests were evaluated
    - Which professor research areas were considered
    - Why no overlap was found
    - Any edge cases considered
  - [ ] Format:
    ```markdown
    # Filtered Professors Report

    ## Summary
    - Total professors evaluated: 150
    - Included for analysis: 85 (56.7%)
    - Excluded: 65 (43.3%)

    ## Excluded Professors

    | Professor | Department | Research Areas | Confidence | Reason |
    |-----------|------------|----------------|------------|--------|
    | Dr. John Doe | Literature | Poetry, Renaissance Lit | 95 | No overlap with bioengineering |

    ### Detailed Exclusion Reasoning

    **Dr. John Doe (Excluded)**
    - Research: Poetry, Renaissance Literature
    - User Interests: Bioengineering, Tissue Engineering
    - Reasoning: Professor's humanities focus in literature has no overlap
      with user's technical bioengineering interests. No computational or
      data-related research detected.
    - Confidence: 95
    ```

- [ ] **Task 3: Include Included Professors Summary** (AC: 6)
  - [ ] Add "Included Professors" section to report
  - [ ] List professors that PASSED filter with high confidence
  - [ ] Show why they were included (matching research areas)
  - [ ] Format similar to excluded table
  - [ ] Helps user validate correct inclusions

- [ ] **Task 4: Add Filtering Statistics** (AC: 6)
  - [ ] Calculate and display:
    - Total professors: X
    - Included: Y (Z%)
    - Excluded: A (B%)
    - By confidence level:
      - High confidence exclusions: C
      - Low confidence exclusions: D (flagged for review)
  - [ ] Include department-level stats:
    - Departments with 100% exclusion rate
    - Departments with high inclusion rate
  - [ ] Display in report summary

- [ ] **Task 5: Enable Manual Professor Addition** (AC: 5)
  - [ ] First, add `"manual_addition"` to `PROFESSOR_DATA_QUALITY_FLAGS` in `src/models/professor.py`
  - [ ] Support `config/manual-professor-additions.json`:
    ```json
    {
      "additions": [
        {
          "professor_id": "prof-456",
          "reason": "User identified as relevant despite filter"
        }
      ]
    }
    ```
  - [ ] Load additions and mark professors as `is_filtered = True`
  - [ ] Override filter decision
  - [ ] Add flag using `professor.add_quality_flag("manual_addition")`
  - [ ] Log: "Added X professors manually by user override"

- [ ] **Task 6: Add Search/Filter Functionality Guidance** (AC: 5)
  - [ ] At end of report, provide instructions:
    ```markdown
    ## How to Override Filter Decisions

    If you believe a professor was incorrectly filtered:

    1. Create/edit `config/manual-professor-additions.json`
    2. Add professor ID to "additions" list
    3. Re-run the pipeline from Phase 3

    The professor will be included in subsequent analysis.
    ```
  - [ ] Include example JSON format

- [ ] **Task 7: Cross-Reference with Borderline Cases** (AC: 3) *[Requires Story 3.3 complete]*
  - [ ] Link to borderline-professors.md report (created by Story 3.3)
  - [ ] In filtered-professors.md, add note:
    ```markdown
    **Note:** See `borderline-professors.md` for low-confidence
    decisions that may require manual review.
    ```
  - [ ] Ensure reports are consistent (same professors, same reasoning)
  - [ ] If borderline-professors.md doesn't exist (Story 3.3 not implemented), skip cross-reference gracefully

## Dev Notes

### Relevant Architecture Information

**Component:** Professor Filter Agent - Transparency Logging Module (Epic 3)

**Responsibility:** Provide transparent logging of all filter decisions (Epic 3: FR13)

**Key Interfaces:**
- `generate_filter_report(professors: list[Professor]) -> None` - Create filtered-professors.md
- `log_filter_decision(professor: Professor) -> None` - Log decision using professor.is_filtered, filter_confidence, filter_reasoning fields

**Dependencies:**
- Structured Logger for decision logging (Story 1.7)
- Professor Filter Agent from Story 3.2 (provides `is_filtered`, `filter_reasoning` fields)
- Confidence Scoring from Story 3.3 (provides `filter_confidence` field and borderline-professors.md)
- Professor model with `data_quality_flags: list[str]` field (Story 3.1)
- File system for report generation

**Technology Stack:**
- structlog for structured logging
- Markdown generation for reports
- Python statistics for filter stats

**Source Tree Location:**
- Modify: `src/agents/professor_filter.py` (add reporting logic)
- Modify: `src/models/professor.py` (add "manual_addition" to PROFESSOR_DATA_QUALITY_FLAGS constant)
- Create: `output/filtered-professors.md` (main report)
- Optional: `config/manual-professor-additions.json` (user overrides)

**Checkpoint Files:**
- Input: `checkpoints/phase-3-professor-filter-batch-N.jsonl` (filtered professors from Story 3.2/3.3)
- No new checkpoint created by this story (reporting only)

**Filtered Professors Report Structure:**
```markdown
# Filtered Professors Report

## Executive Summary
- **Total Professors Evaluated:** 150
- **Included for Analysis:** 85 (56.7%)
- **Excluded:** 65 (43.3%)
- **Low-Confidence Decisions:** 12 (see borderline-professors.md)

## Filtering Statistics by Department

| Department | Total | Included | Excluded | Inclusion Rate |
|------------|-------|----------|----------|----------------|
| Computer Science | 25 | 20 | 5 | 80% |
| Bioengineering | 30 | 28 | 2 | 93% |
| Literature | 15 | 0 | 15 | 0% |

## Excluded Professors

### High Confidence Exclusions (≥90)
[Table with professors clearly unrelated]

### Medium Confidence Exclusions (70-89)
[Table with professors moderately unrelated]

### Low Confidence Exclusions (<70)
**⚠️ Review Recommended** - See borderline-professors.md

## Included Professors Summary

### High Confidence Inclusions (≥90)
[Top matching professors with clear alignment]

## How to Override Filter Decisions
[Instructions for manual additions]
```

**Logging Strategy:**
- **All decisions logged:** Both include and exclude
- **Structured JSON logs:** Machine-parseable for analysis
- **Human-readable report:** Markdown for user review
- **Cross-referenced:** Link to borderline cases report

**Statistics Calculation:**
```python
def calculate_filter_statistics(professors: list[Professor]) -> dict:
    total = len(professors)
    included = [p for p in professors if p.is_filtered]
    excluded = [p for p in professors if not p.is_filtered]

    return {
        "total": total,
        "included": {
            "count": len(included),
            "percentage": len(included) / total * 100,
            "high_confidence": len([p for p in included if p.filter_confidence >= 90]),
            "medium_confidence": len([p for p in included if 70 <= p.filter_confidence < 90]),
            "low_confidence": len([p for p in included if p.filter_confidence < 70])
        },
        "excluded": {
            "count": len(excluded),
            "percentage": len(excluded) / total * 100,
            "high_confidence": len([p for p in excluded if p.filter_confidence >= 90]),
            "medium_confidence": len([p for p in excluded if 70 <= p.filter_confidence < 90]),
            "low_confidence": len([p for p in excluded if p.filter_confidence < 70])
        }
    }
```

**Critical Rules (from Coding Standards):**
- Never use print() for logging (use structlog)
- All filter decisions must be logged
- Reports must be human-readable markdown
- Statistics must be accurate and comprehensive

**Architecture Component Diagram Flow:**
```
Professor Filter Agent → Structured Logger (log all decisions)
Professor Filter Agent → Report Generator (filtered-professors.md)
Professor Filter Agent → Stats Calculator (filter statistics)
Professor Filter Agent → Manual Override Handler (load additions)
```

### Testing

**Test File Location:** `tests/unit/test_filter_logging.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Test report generation with mock data
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Test filter decision logging to structlog
2. Test filtered-professors.md report generation
3. Test filtering statistics calculation
4. Test manual professor addition loading
5. Test cross-referencing with borderline cases
6. Test report formatting (markdown validity)
7. Test edge cases (all included, all excluded, empty list)

**Example Test Pattern:**
```python
def test_generate_filter_report(tmp_path):
    # Arrange
    professors = [
        Professor(
            id="1", name="Dr. Smith", title="Professor",
            department_id="cs-1", department_name="Computer Science",
            profile_url="https://example.edu/smith",
            research_areas=["AI", "ML"],
            is_filtered=True,
            filter_confidence=95,
            filter_reasoning="Strong match with user's AI interests"
        ),
        Professor(
            id="2", name="Dr. Doe", title="Professor",
            department_id="lit-1", department_name="Literature",
            profile_url="https://example.edu/doe",
            research_areas=["Poetry"],
            is_filtered=False,
            filter_confidence=98,
            filter_reasoning="No overlap with user's technical interests"
        ),
    ]
    agent = ProfessorFilterAgent(output_dir=tmp_path)

    # Act
    agent.generate_filter_report(professors)

    # Assert
    report_path = tmp_path / "filtered-professors.md"
    assert report_path.exists()
    content = report_path.read_text()
    assert "Dr. Smith" in content
    assert "Dr. Doe" in content
    assert "Included: 1 (50%)" in content
    assert "Excluded: 1 (50%)" in content
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-07 | 0.2 | **VALIDATION FIXES:** (1) Added Dependencies section clarifying Stories 3.2 and 3.3 must be complete first; (2) Fixed ALL field name mismatches: is_relevant→is_filtered, relevance_confidence→filter_confidence, relevance_reasoning→filter_reasoning (aligns with data-models.md Professor schema); (3) Merged Task 6 into Task 2 to eliminate duplication of detailed reasoning content; (4) Updated Task 5 to add "manual_addition" to PROFESSOR_DATA_QUALITY_FLAGS constant; (5) Renumbered Task 7→6, Task 8→7; (6) Updated Task 7 to clarify Story 3.3 dependency with graceful fallback if borderline-professors.md doesn't exist; (7) Added checkpoint naming convention to Dev Notes; (8) Updated all code examples, statistics calculation, and test patterns to use correct field names; (9) Enhanced Dependencies section in Dev Notes with specific field references; (10) Updated Key Interfaces signature for log_filter_decision | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
