# Story 3.4: Filtered Professor Logging & Transparency

## Status

**Draft**

## Story

**As a** user,
**I want** detailed logs of filtered-out professors with reasoning,
**so that** I can validate the system didn't miss relevant labs.

## Acceptance Criteria

1. All filtered professors logged with exclusion reasoning (FR13)
2. Log includes: professor name, department, research areas, confidence score, filter reason
3. Log saved to dedicated file (filtered-professors.md or similar)
4. Reasoning explains why research didn't align
5. User can review and manually add back professors if needed
6. Statistics provided: "Filtered X of Y professors (Z%)"

## Tasks / Subtasks

- [ ] **Task 1: Log All Filter Decisions to Structured Logger** (AC: 1, 2)
  - [ ] Use structlog from Story 1.7
  - [ ] Log every filter decision at INFO level
  - [ ] Log format:
    ```json
    {
      "component": "professor_filter",
      "professor_id": "prof-123",
      "professor_name": "Dr. John Doe",
      "department": "Literature",
      "school": "Arts & Sciences",
      "research_areas": ["Poetry", "Renaissance Literature"],
      "decision": "exclude",
      "confidence": 95,
      "reasoning": "No overlap with user's bioengineering interests"
    }
    ```
  - [ ] Ensure correlation_id in all logs for traceability

- [ ] **Task 2: Generate Filtered Professors Report** (AC: 3, 4)
  - [ ] Create `output/filtered-professors.md` markdown report
  - [ ] Structure:
    - Summary section with statistics
    - Table of excluded professors
    - Detailed reasoning for each
  - [ ] Format:
    ```markdown
    # Filtered Professors Report

    ## Summary
    - Total professors evaluated: 150
    - Included for analysis: 85 (56.7%)
    - Excluded: 65 (43.3%)

    ## Excluded Professors

    | Professor | Department | Research Areas | Confidence | Reason |
    |-----------|------------|----------------|------------|--------|
    | Dr. John Doe | Literature | Poetry, Renaissance Lit | 95 | No overlap with bioengineering |
    ```

- [ ] **Task 3: Include Included Professors Summary** (AC: 6)
  - [ ] Add "Included Professors" section to report
  - [ ] List professors that PASSED filter with high confidence
  - [ ] Show why they were included (matching research areas)
  - [ ] Format similar to excluded table
  - [ ] Helps user validate correct inclusions

- [ ] **Task 4: Add Filtering Statistics** (AC: 6)
  - [ ] Calculate and display:
    - Total professors: X
    - Included: Y (Z%)
    - Excluded: A (B%)
    - By confidence level:
      - High confidence exclusions: C
      - Low confidence exclusions: D (flagged for review)
  - [ ] Include department-level stats:
    - Departments with 100% exclusion rate
    - Departments with high inclusion rate
  - [ ] Display in report summary

- [ ] **Task 5: Enable Manual Professor Addition** (AC: 5)
  - [ ] Support `config/manual-professor-additions.json`:
    ```json
    {
      "additions": [
        {
          "professor_id": "prof-456",
          "reason": "User identified as relevant despite filter"
        }
      ]
    }
    ```
  - [ ] Load additions and mark professors as `is_relevant = True`
  - [ ] Override filter decision
  - [ ] Flag with `data_quality_flags: ["manual_addition"]`
  - [ ] Log: "Added X professors manually by user override"

- [ ] **Task 6: Create Detailed Reasoning Explanations** (AC: 4)
  - [ ] For each excluded professor, provide detailed reasoning:
    - What user research interests were evaluated
    - Which professor research areas were considered
    - Why no overlap was found
    - Any edge cases considered
  - [ ] Example:
    ```
    **Dr. Jane Smith (Excluded)**
    - Research: Ancient Greek Philosophy, Ethics
    - User Interests: Machine Learning, Neural Networks
    - Reasoning: Professor's humanities focus in philosophy has no
      overlap with user's technical AI/ML interests in computer science.
      No computational or data-related research detected.
    - Confidence: 98
    ```

- [ ] **Task 7: Add Search/Filter Functionality Guidance** (AC: 5)
  - [ ] At end of report, provide instructions:
    ```markdown
    ## How to Override Filter Decisions

    If you believe a professor was incorrectly filtered:

    1. Create/edit `config/manual-professor-additions.json`
    2. Add professor ID to "additions" list
    3. Re-run the pipeline from Phase 3

    The professor will be included in subsequent analysis.
    ```
  - [ ] Include example JSON format

- [ ] **Task 8: Cross-Reference with Borderline Cases** (AC: 3)
  - [ ] Link to borderline-professors.md report (from Story 3.3)
  - [ ] In filtered-professors.md, add note:
    ```markdown
    **Note:** See `borderline-professors.md` for low-confidence
    decisions that may require manual review.
    ```
  - [ ] Ensure reports are consistent (same professors, same reasoning)

## Dev Notes

### Relevant Architecture Information

**Component:** Professor Filter Agent - Transparency Logging Module (Epic 3)

**Responsibility:** Provide transparent logging of all filter decisions (Epic 3: FR13)

**Key Interfaces:**
- `generate_filter_report(professors: list[Professor]) -> None` - Create filtered-professors.md
- `log_filter_decision(professor: Professor, decision: str, reasoning: str) -> None`

**Dependencies:**
- Structured Logger for decision logging (Story 1.7)
- Professor Filter Agent from Story 3.2
- Confidence Scoring from Story 3.3
- File system for report generation

**Technology Stack:**
- structlog for structured logging
- Markdown generation for reports
- Python statistics for filter stats

**Source Tree Location:**
- Modify: `src/agents/professor_filter.py` (add reporting logic)
- Create: `output/filtered-professors.md` (main report)
- Optional: `config/manual-professor-additions.json` (user overrides)

**Filtered Professors Report Structure:**
```markdown
# Filtered Professors Report

## Executive Summary
- **Total Professors Evaluated:** 150
- **Included for Analysis:** 85 (56.7%)
- **Excluded:** 65 (43.3%)
- **Low-Confidence Decisions:** 12 (see borderline-professors.md)

## Filtering Statistics by Department

| Department | Total | Included | Excluded | Inclusion Rate |
|------------|-------|----------|----------|----------------|
| Computer Science | 25 | 20 | 5 | 80% |
| Bioengineering | 30 | 28 | 2 | 93% |
| Literature | 15 | 0 | 15 | 0% |

## Excluded Professors

### High Confidence Exclusions (≥90)
[Table with professors clearly unrelated]

### Medium Confidence Exclusions (70-89)
[Table with professors moderately unrelated]

### Low Confidence Exclusions (<70)
**⚠️ Review Recommended** - See borderline-professors.md

## Included Professors Summary

### High Confidence Inclusions (≥90)
[Top matching professors with clear alignment]

## How to Override Filter Decisions
[Instructions for manual additions]
```

**Logging Strategy:**
- **All decisions logged:** Both include and exclude
- **Structured JSON logs:** Machine-parseable for analysis
- **Human-readable report:** Markdown for user review
- **Cross-referenced:** Link to borderline cases report

**Statistics Calculation:**
```python
def calculate_filter_statistics(professors: list[Professor]) -> dict:
    total = len(professors)
    included = [p for p in professors if p.is_relevant]
    excluded = [p for p in professors if not p.is_relevant]

    return {
        "total": total,
        "included": {
            "count": len(included),
            "percentage": len(included) / total * 100,
            "high_confidence": len([p for p in included if p.relevance_confidence >= 90]),
            "medium_confidence": len([p for p in included if 70 <= p.relevance_confidence < 90]),
            "low_confidence": len([p for p in included if p.relevance_confidence < 70])
        },
        "excluded": {
            "count": len(excluded),
            "percentage": len(excluded) / total * 100,
            "high_confidence": len([p for p in excluded if p.relevance_confidence >= 90]),
            "medium_confidence": len([p for p in excluded if 70 <= p.relevance_confidence < 90]),
            "low_confidence": len([p for p in excluded if p.relevance_confidence < 70])
        }
    }
```

**Critical Rules (from Coding Standards):**
- Never use print() for logging (use structlog)
- All filter decisions must be logged
- Reports must be human-readable markdown
- Statistics must be accurate and comprehensive

**Architecture Component Diagram Flow:**
```
Professor Filter Agent → Structured Logger (log all decisions)
Professor Filter Agent → Report Generator (filtered-professors.md)
Professor Filter Agent → Stats Calculator (filter statistics)
Professor Filter Agent → Manual Override Handler (load additions)
```

### Testing

**Test File Location:** `tests/unit/test_filter_logging.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Test report generation with mock data
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Test filter decision logging to structlog
2. Test filtered-professors.md report generation
3. Test filtering statistics calculation
4. Test manual professor addition loading
5. Test cross-referencing with borderline cases
6. Test report formatting (markdown validity)
7. Test edge cases (all included, all excluded, empty list)

**Example Test Pattern:**
```python
def test_generate_filter_report(tmp_path):
    # Arrange
    professors = [
        Professor(id="1", name="Dr. Smith", department="CS",
                 research_areas=["AI", "ML"], is_relevant=True,
                 relevance_confidence=95, relevance_reasoning="Strong match"),
        Professor(id="2", name="Dr. Doe", department="Literature",
                 research_areas=["Poetry"], is_relevant=False,
                 relevance_confidence=98, relevance_reasoning="No overlap"),
    ]
    agent = ProfessorFilterAgent(output_dir=tmp_path)

    # Act
    agent.generate_filter_report(professors)

    # Assert
    report_path = tmp_path / "filtered-professors.md"
    assert report_path.exists()
    content = report_path.read_text()
    assert "Dr. Smith" in content
    assert "Dr. Doe" in content
    assert "Included: 1 (50%)" in content
    assert "Excluded: 1 (50%)" in content
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
