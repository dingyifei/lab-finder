# Story 2.2: Department Structure JSON Representation

## Status

**Draft**

## Story

**As a** user,
**I want** the discovered department structure saved in JSON format,
**so that** sub-agents can be delegated to process specific departments in parallel.

## Acceptance Criteria

1. Department hierarchy represented in structured JSON (FR8)
2. JSON includes: school name, division name, department name, department URL, hierarchy level
3. JSON enables easy iteration and sub-agent delegation
4. File saved as intermediate result for resumability (NFR12)
5. Human-readable formatting for manual review if needed
6. Schema supports multi-level hierarchies (minimum 3 levels deep)

## Tasks / Subtasks

- [ ] **Task 1: Load Department Data from Checkpoint** (AC: 4)
  - [ ] Use `checkpoint_manager.load_batches("phase-1")` from Story 1.7
  - [ ] Load department records from `checkpoints/phase-1-departments.jsonl`
  - [ ] Deserialize JSONL to Department Pydantic models
  - [ ] Verify all departments loaded successfully

- [ ] **Task 2: Transform to Hierarchical JSON Structure** (AC: 1, 2, 6)
  - [ ] Create hierarchical representation grouping by school → division → department
  - [ ] JSON structure:
    ```json
    {
      "university": "Stanford University",
      "discovery_date": "2025-10-06",
      "schools": [
        {
          "name": "School of Engineering",
          "url": "https://...",
          "divisions": [
            {
              "name": "Division Name",
              "url": "https://...",
              "departments": [
                {
                  "id": "dept-001",
                  "name": "Computer Science",
                  "url": "https://...",
                  "hierarchy_level": 2
                }
              ]
            }
          ]
        }
      ]
    }
    ```
  - [ ] Handle flat structures (no divisions) gracefully
  - [ ] Preserve all metadata from Department models

- [ ] **Task 3: Validate JSON Schema** (AC: 6)
  - [ ] Define JSON schema for department structure
  - [ ] Validate generated JSON against schema
  - [ ] Ensure supports minimum 3 hierarchy levels
  - [ ] Handle edge cases (single-level, two-level structures)

- [ ] **Task 4: Enable Sub-Agent Iteration** (AC: 3)
  - [ ] Provide utility function `get_departments_for_delegation() -> list[Department]`
  - [ ] Function returns flattened list of all departments for parallel processing
  - [ ] Include department ID and hierarchy context for agent context
  - [ ] Ensure easy iteration for Epic 3 professor discovery

- [ ] **Task 5: Save JSON with Human-Readable Formatting** (AC: 4, 5)
  - [ ] Save to `checkpoints/phase-1-department-structure.json`
  - [ ] Use `json.dumps()` with `indent=2` for readability
  - [ ] Include metadata: discovery timestamp, total counts
  - [ ] Log file location after save
  - [ ] Verify file exists and is valid JSON

- [ ] **Task 6: Add Department Count Summary** (AC: 5)
  - [ ] Calculate summary statistics:
    - Total schools discovered
    - Total divisions discovered
    - Total departments discovered
  - [ ] Include in JSON metadata section
  - [ ] Display summary in progress tracker
  - [ ] Log summary: "Discovered X schools, Y divisions, Z departments"

## Dev Notes

### Relevant Architecture Information

**Component:** University Structure Discovery Agent (Epic 2)

**Responsibility:** Transform flat department list to hierarchical JSON for delegation (Epic 2: FR8)

**Key Interfaces:**
- `create_hierarchical_json(departments: list[Department]) -> dict` - Build hierarchy from flat list
- `get_departments_for_delegation() -> list[Department]` - Return flattened list for parallel processing

**Dependencies:**
- Checkpoint Manager for loading phase-1 departments (Story 1.7)
- Department Pydantic model from Story 2.1

**Technology Stack:**
- Python json library with indent formatting
- Pydantic `.model_dump()` for serialization
- JSON schema validation

**Source Tree Location:**
- Modify: `src/agents/university_discovery.py` (add JSON transformation methods)
- Create: `checkpoints/phase-1-department-structure.json` (output)

**Department JSON Schema:**

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["university", "discovery_date", "schools"],
  "properties": {
    "university": {"type": "string"},
    "discovery_date": {"type": "string", "format": "date"},
    "total_schools": {"type": "integer"},
    "total_divisions": {"type": "integer"},
    "total_departments": {"type": "integer"},
    "schools": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "url"],
        "properties": {
          "name": {"type": "string"},
          "url": {"type": "string", "format": "uri"},
          "divisions": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "departments"],
              "properties": {
                "name": {"type": "string"},
                "url": {"type": "string", "format": "uri"},
                "departments": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["id", "name", "url", "hierarchy_level"],
                    "properties": {
                      "id": {"type": "string"},
                      "name": {"type": "string"},
                      "url": {"type": "string", "format": "uri"},
                      "hierarchy_level": {"type": "integer", "minimum": 0}
                    }
                  }
                }
              }
            }
          },
          "departments": {
            "type": "array",
            "description": "Direct departments if no divisions",
            "items": {"$ref": "#/properties/schools/items/properties/divisions/items/properties/departments/items"}
          }
        }
      }
    }
  }
}
```

**Critical Rules (from Coding Standards):**
- Always type hint function signatures
- Never use print() for logging (use structlog)
- Use checkpoint_manager for loading - never read JSONL directly
- Validate JSON against schema before saving

**Architecture Component Diagram Flow:**
```
University Discovery Agent → Checkpoint Manager (loads phase-1-departments.jsonl)
University Discovery Agent → JSON Transformer (creates hierarchy)
University Discovery Agent → File System (saves phase-1-department-structure.json)
```

### Testing

**Test File Location:** `tests/unit/test_department_json.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Unit tests with fixture department data
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Unit test for hierarchical JSON creation from flat department list
2. Test schema validation (valid and invalid structures)
3. Test `get_departments_for_delegation()` returns correct flattened list
4. Test handling of different hierarchy depths (1-level, 2-level, 3-level)
5. Test JSON serialization and file save
6. Test summary statistics calculation

**Example Test Pattern:**
```python
def test_create_hierarchical_json():
    # Arrange
    departments = [
        Department(id="1", name="CS", school="Engineering", division=None,
                   url="https://cs.edu", hierarchy_level=1),
        Department(id="2", name="EE", school="Engineering", division=None,
                   url="https://ee.edu", hierarchy_level=1),
    ]

    # Act
    json_structure = create_hierarchical_json(departments)

    # Assert
    assert json_structure["university"] is not None
    assert len(json_structure["schools"]) == 1
    assert json_structure["schools"][0]["name"] == "Engineering"
    assert len(json_structure["schools"][0]["departments"]) == 2
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
