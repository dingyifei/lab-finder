# Story 2.2: Department Structure JSON Representation

## Status

**Done** (Completed 2025-10-07, QA Approved 2025-10-07)

## Story

**As a** user,
**I want** the discovered department structure saved in JSON format,
**so that** departments can be processed in parallel using async tasks.

## Dependencies

**Prerequisite Stories:**
- **Story 1.4** (Shared Utilities Implementation) - Required for checkpoint_manager utility
- **Story 2.1** (University Website Structure Discovery) - Must complete before starting
  - Provides: `checkpoints/phase-1-departments.jsonl` with discovered departments (single consolidated file)
  - Note: Story 2.1 requires Stories 2.4 AND 2.5 complete before it can start
- **Story 2.4** (Error Handling for Missing Structure Data) - Provides Department model with data_quality_flags
- **Story 2.5** (Batch Configuration) - Indirect dependency (required for Story 2.1)

**Execution Order:** Epic 2 Phase 3 story - can only start after Phase 1 (2.4, 2.5) and Phase 2 (2.1) complete

## Acceptance Criteria

1. Department hierarchy represented in structured JSON (FR8)
2. JSON includes: school name, division name, department name, department URL, hierarchy level
3. JSON enables easy iteration and parallel async processing
4. File saved as intermediate result for resumability (NFR12)
5. Human-readable formatting for manual review if needed
6. Schema supports multi-level hierarchies (minimum 3 levels deep)

## Tasks / Subtasks

- [x] **Task 1: Load Department Data from Checkpoint** (AC: 4)
  - [x] Use `checkpoint_manager.load_batches("phase-1-departments")` to load all departments
  - [x] Load department records from `checkpoints/phase-1-departments.jsonl` (single consolidated file from Story 2.1)
  - [x] Deserialize JSONL records to Department Pydantic models (import: `from src.models.department import Department`)
  - [x] Verify all departments loaded successfully (expect list of Department objects)
  - [x] Handle edge cases: empty checkpoint, missing file, deserialization errors
  - [x] If no departments found, log error and halt execution (cannot proceed without Story 2.1 output):
    ```python
    logger.error(
        "No departments found in checkpoint",
        checkpoint_file="phase-1-departments.jsonl",
        action="Verify Story 2.1 completed successfully"
    )
    raise RuntimeError("Cannot proceed without Story 2.1 department data")
    ```

- [x] **Task 2: Calculate Department Count Summary** (AC: 5)
  - [x] Calculate summary statistics from loaded departments:
    - Total schools discovered (count unique school names)
    - Total divisions discovered (count unique division names where not None)
    - Total departments discovered (total count of all departments)
  - [x] Store statistics for use in Task 3 JSON generation
  - [x] Display summary in progress tracker
  - [x] Log summary: "Discovered X schools, Y divisions, Z departments"

- [x] **Task 3: Transform to Hierarchical JSON Structure** (AC: 1, 2, 6)
  - **Purpose:** Create human-readable hierarchical representation for documentation and manual review
  - **Note:** This JSON is for human inspection only; Epic 3 will use Task 5's flattened list for parallel processing
  - [x] Implement `create_hierarchical_json(departments: list[Department], stats: dict) -> dict` method in `src/agents/university_discovery.py`
  - [x] Create hierarchical representation grouping by school → division → department
  - [x] JSON structure:
    ```json
    {
      "university": "Stanford University",
      "discovery_date": "2025-10-06",
      "total_schools": 7,
      "total_divisions": 15,
      "total_departments": 85,
      "schools": [
        {
          "name": "School of Engineering",
          "url": "https://...",
          "divisions": [
            {
              "name": "Division Name",
              "url": "https://...",
              "departments": [
                {
                  "id": "dept-001",
                  "name": "Computer Science",
                  "url": "https://...",
                  "hierarchy_level": 2
                }
              ]
            }
          ]
        }
      ]
    }
    ```
  - [x] Handle flat structures (no divisions) gracefully:
        - If department.division is None, place department directly under school
        - Use "departments" array instead of "divisions" array in JSON
        - See schema line 211 for direct departments structure
  - [x] Preserve all metadata from Department models
  - [x] Include summary statistics from Task 2 in JSON metadata (total_schools, total_divisions, total_departments)
  - [x] Extract university name using this priority:
        1. Check if config file `config/university_config.json` exists and has `university_name` field
        2. Fallback: Extract domain from first department URL (e.g., "stanford.edu" → "Stanford University")
        3. If both fail: Use "Unknown University" and log warning
  - [x] Use current date (ISO 8601 format: YYYY-MM-DD) for discovery_date field

- [x] **Task 4: Validate JSON Schema** (AC: 6)
  - [x] Create `src/schemas/department-structure.schema.json` with the schema defined in Dev Notes section "Department JSON Schema" below
  - [x] Use `jsonschema` library for validation (already in tech stack per Story 1.2)
  - [x] Validate generated JSON from Task 3 against schema using `jsonschema.validate(instance, schema)`
  - [x] Handle ValidationError exceptions with clear error messages
  - [x] Ensure supports minimum 3 hierarchy levels
  - [x] Handle edge cases (single-level, two-level structures)

- [x] **Task 5: Enable Parallel Async Iteration** (AC: 3)
  - [x] Add method `get_departments_for_parallel_processing() -> list[Department]` to `src/agents/university_discovery.py`
  - [x] Function loads departments from checkpoint using checkpoint_manager (independent of hierarchical JSON from Task 3)
  - [x] Function returns flattened list of all departments for parallel async processing
  - [x] Include department ID and hierarchy context for task context
  - [x] Ensure easy iteration for Epic 3 professor discovery using asyncio.gather() pattern
  - [x] Note: Implement as regular `def` (synchronous) since it only loads from checkpoint, no async I/O needed

- [x] **Task 6: Save JSON with Human-Readable Formatting** (AC: 4, 5)
  - [x] Save to `checkpoints/phase-1-department-structure.json`
  - [x] Use `json.dumps()` with `indent=2` for readability
  - [x] Include metadata: discovery timestamp, total counts (from Task 2)
  - [x] Log file location after save
  - [x] Verify file exists and is valid JSON

## Dev Notes

### Relevant Architecture Information

**Component:** University Structure Discovery Agent (Epic 2)

**Responsibility:** Transform flat department list to hierarchical JSON for delegation (Epic 2: FR8)

**Note on Parallel Execution:**
Story 2.2 and Story 2.3 both consume Story 2.1's checkpoint (`phase-1-departments.jsonl`) and run in parallel (Epic 2 Phase 3). Story 2.2 produces a documentation artifact (hierarchical JSON for human review and architectural reference) while Story 2.3 produces the filtered department list for Epic 3. These outputs are independent and do not interfere with each other.

**Key Interfaces:**
- `create_hierarchical_json(departments: list[Department]) -> dict` - Build hierarchy from flat list
- `get_departments_for_parallel_processing() -> list[Department]` - Return flattened list for parallel async processing

**Dependencies:**
- Checkpoint Manager for loading phase-1 departments (Story 1.4)
- Department Pydantic model from Story 2.1/2.4

**Department Model (Story 2.4):**
- **Import:** `from src.models.department import Department`
- **Location:** `src/models/department.py`
- **Key Fields:**
  - `id: str` - Unique identifier (UUID[:8])
  - `name: str` - Department name
  - `school: Optional[str]` - Parent school/college
  - `division: Optional[str]` - Parent division
  - `url: str` - Department homepage URL
  - `hierarchy_level: int` - Depth in org tree (0=school, 1=division, 2=department)
  - `data_quality_flags: list[str]` - Quality issues
  - `is_relevant: bool` - Filtering result (added by Story 2.3)
  - `relevance_reasoning: str` - LLM explanation (added by Story 2.3)
- **Reference:** See Story 2.1 Dev Notes lines 114-127 for complete model definition

**Technology Stack:**
- Python json library with indent formatting
- Pydantic `.model_dump()` for serialization
- JSON schema validation

**Required Imports:**
```python
from src.models.department import Department
from src.utils.checkpoint_manager import CheckpointManager
import json
import jsonschema
from datetime import date
```

**Source Tree Location:**
- Modify: `src/agents/university_discovery.py` (add JSON transformation methods)
- Create: `checkpoints/phase-1-department-structure.json` (output)

**Department JSON Schema:**

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["university", "discovery_date", "schools"],
  "properties": {
    "university": {"type": "string"},
    "discovery_date": {"type": "string", "format": "date"},
    "total_schools": {"type": "integer"},
    "total_divisions": {"type": "integer"},
    "total_departments": {"type": "integer"},
    "schools": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "url"],
        "properties": {
          "name": {"type": "string"},
          "url": {"type": "string", "format": "uri"},
          "divisions": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "departments"],
              "properties": {
                "name": {"type": "string"},
                "url": {"type": "string", "format": "uri"},
                "departments": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["id", "name", "url", "hierarchy_level"],
                    "properties": {
                      "id": {"type": "string"},
                      "name": {"type": "string"},
                      "url": {"type": "string", "format": "uri"},
                      "hierarchy_level": {"type": "integer", "minimum": 0}
                    }
                  }
                }
              }
            }
          },
          "departments": {
            "type": "array",
            "description": "Direct departments if no divisions",
            "items": {"$ref": "#/properties/schools/items/properties/divisions/items/properties/departments/items"}
          }
        }
      }
    }
  }
}
```

**JSON Schema Validation (Task 4 Implementation):**
- Use `jsonschema` library (already in tech stack per Story 1.2)
- Import: `import jsonschema`
- Validate: `jsonschema.validate(instance=json_data, schema=schema_dict)`
- Schema uses `"$ref"` for internal references (line 163) - jsonschema handles this automatically
- Catch `jsonschema.ValidationError` and provide clear error messages to user
- Example pattern:
  ```python
  try:
      jsonschema.validate(instance=hierarchy_json, schema=dept_schema)
      logger.info("JSON schema validation passed")
  except jsonschema.ValidationError as e:
      logger.error("JSON validation failed", error=str(e), path=list(e.path))
      raise
  ```

**Critical Rules (from Coding Standards):**
- Always type hint function signatures
- Never use print() for logging (use structlog)
- Use checkpoint_manager for loading - never read JSONL directly
- Validate JSON against schema before saving

**Architecture Component Diagram Flow:**
```
University Discovery Agent → Checkpoint Manager (loads phase-1-departments.jsonl)
University Discovery Agent → JSON Transformer (creates hierarchy)
University Discovery Agent → File System (saves phase-1-department-structure.json)
```

### Testing

**Test File Location:** `tests/unit/test_department_json.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Unit tests with fixture department data
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Unit test for hierarchical JSON creation from flat department list
2. Test schema validation (valid and invalid structures)
3. Test `get_departments_for_parallel_processing()` returns correct flattened list
4. Test handling of different hierarchy depths (1-level, 2-level, 3-level)
5. Test JSON serialization and file save
6. Test summary statistics calculation

**Example Test Pattern:**
```python
def test_create_hierarchical_json():
    # Arrange
    departments = [
        Department(id="1", name="CS", school="Engineering", division=None,
                   url="https://cs.edu", hierarchy_level=1),
        Department(id="2", name="EE", school="Engineering", division=None,
                   url="https://ee.edu", hierarchy_level=1),
    ]

    # Act
    json_structure = create_hierarchical_json(departments)

    # Assert
    assert json_structure["university"] is not None
    assert len(json_structure["schools"]) == 1
    assert json_structure["schools"][0]["name"] == "Engineering"
    assert len(json_structure["schools"][0]["departments"]) == 2
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-07 | 0.2 | Applied validation fixes: added checkpoint error handling to Task 1 (missing file/empty checkpoint handling), specified JSON schema storage location in Task 3 (`src/schemas/department-structure.schema.json`), added jsonschema library validation guidance with example code in Dev Notes | Sarah (PO) |
| 2025-10-07 | 0.3 | Addressed validation issues: clarified checkpoint loading API in Task 1 (`load_batches("phase-1-departments")`), added specific error message template for missing checkpoint, added parallel execution clarification note to Dev Notes explaining Story 2.2/2.3 independence | Sarah (PO) |
| 2025-10-07 | 0.4 | Applied comprehensive validation fixes: (P1) Added implementation location to Task 2 (`src/agents/university_discovery.py`), clarified schema copy instructions in Task 3, specified Task 4 independence from Task 2; (P2) Added Dependencies section, reordered Task 5/6 (summary before save), Task 2 now includes function signature | Sarah (PO) |
| 2025-10-07 | 0.5 | **Critical validation fixes:** (1) Resolved checkpoint naming inconsistency - unified to `phase-1-departments.jsonl` single file pattern per Story 2.1, updated Dependencies and Task 1; (2) Added Department model import reference to Dev Notes with complete field list; (3) Clarified Task 2 purpose (documentation artifact); (4) Added university name/date extraction to Task 2; (5) Improved schema copy instruction in Task 3; (6) Added Required Imports section to Dev Notes | Sarah (PO) |
| 2025-10-07 | 0.6 | **Production-readiness validation fixes:** (Critical) Fixed task sequencing - moved summary statistics calculation (Task 2) before JSON transformation (Task 3) to resolve data dependency; specified university name extraction priority with explicit fallback logic; (Should-Fix) Added Stories 1.4 and 2.4 to Dependencies section; specified Task 5 implementation location (`src/agents/university_discovery.py`); added flat structure edge case guidance to Task 3; added async/sync clarification to Task 5; updated all internal task references. Story status: NO-GO → GO | Sarah (PO) |
| 2025-10-07 | 0.7 | **Execution order clarification:** Added Story 2.5 as indirect dependency in Dependencies section; added explicit "Execution Order" note clarifying Phase 3 story requires Phase 1 (2.4, 2.5) and Phase 2 (2.1) complete; added note to Story 2.1 dependency explaining it requires 2.4 AND 2.5 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - Implementation completed without issues requiring debug log entries.

### Completion Notes List

- All 6 tasks implemented successfully with comprehensive error handling
- Added 5 new methods to UniversityDiscoveryAgent class: `load_departments_from_checkpoint()`, `calculate_department_summary()`, `create_hierarchical_json()`, `validate_hierarchical_json()`, `get_departments_for_parallel_processing()`, `save_hierarchical_json()`
- Created JSON schema file for department structure validation
- Implemented proper handling of flat vs hierarchical department structures
- Fixed type error in checkpoint loading: Updated to use `load_batches()` return type of `list[dict]` instead of incorrectly assuming dict structure
- All 23 unit tests passing with comprehensive coverage of edge cases (empty checkpoints, deserialization errors, missing files, different hierarchy levels)
- Full regression test suite passed (227 tests, 8 skipped)
- Linting (ruff) and type checking (mypy) passed

### File List

**Modified:**
- `src/agents/university_discovery.py` (Lines 714-1077: Added 6 methods for Story 2.2)

**Created:**
- `src/schemas/department-structure.schema.json` (JSON schema for validation)
- `tests/unit/test_department_json.py` (23 comprehensive unit tests)

**Output (created at runtime):**
- `checkpoints/phase-1-department-structure.json` (Human-readable hierarchical JSON)

## QA Results

### Review Date: 2025-10-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: EXCELLENT** ⭐

This is a textbook example of high-quality implementation. The code demonstrates:

- **Exemplary error handling**: Comprehensive try-except blocks with specific exception types, clear error messages, and proper exception chaining
- **Production-ready logging**: Structured logging with contextual information at all decision points
- **Type safety**: Complete type annotations throughout, mypy validation passing
- **Separation of concerns**: Each method has a single, well-defined responsibility
- **DRY principle**: `get_departments_for_parallel_processing()` correctly reuses the loader
- **Defensive programming**: Null checks, empty list validation, graceful degradation for university name extraction
- **Clean code**: Self-documenting variable names, clear logic flow, minimal cognitive load

**Code Strengths:**
1. Three-tier fallback strategy for university name extraction (config → URL → default) with logging at each step
2. Proper handling of both flat and hierarchical department structures
3. Atomic file operations with verification
4. Excellent docstrings with Args/Returns/Raises sections
5. Smart use of set comprehensions for uniqueness counting

**Minor Observations** (not requiring changes):
- Line 750: Catches bare `Exception` during deserialization - acceptable here since it logs and continues processing other departments
- Line 898: Uses `or "Unknown School"` pattern - works correctly for None but would treat empty string as falsy (edge case unlikely in practice)

### Refactoring Performed

**None**ship - Code quality is already at production standard. No refactoring needed.

### Compliance Check

- ✅ **Coding Standards**: Full compliance
  - Type hints on all function signatures
  - Uses structlog (no print statements)
  - Uses checkpoint_manager (no direct JSONL manipulation)
  - Pydantic models for data structures
  - Proper naming conventions (snake_case functions, PascalCase classes)
  - Optional fields have None defaults

- ✅ **Project Structure**: Full compliance
  - Files in correct locations (`src/agents/`, `src/schemas/`, `tests/unit/`)
  - Test file naming matches implementation (`test_department_json.py`)
  - Schema stored in proper location

- ✅ **Testing Strategy**: Exceeds requirements
  - 23 comprehensive unit tests (100% passing)
  - AAA pattern consistently applied
  - Excellent use of fixtures and parametrization
  - Edge cases well covered (empty lists, missing files, deserialization errors)
  - Integration test for end-to-end workflow
  - Proper mocking of dependencies

- ✅ **All ACs Met**: 6/6 acceptance criteria fully satisfied
  - AC1-6: Each mapped to multiple validating tests
  - Zero coverage gaps identified

### Requirements Traceability Matrix

| AC # | Requirement | Validating Tests | Status |
|------|-------------|------------------|--------|
| AC1 | Department hierarchy in structured JSON | `test_create_hierarchical_json_*` (3 tests) | ✅ PASS |
| AC2 | JSON includes all required fields | Same as AC1 + assertions verify fields | ✅ PASS |
| AC3 | Enables parallel async processing | `test_get_departments_for_parallel_processing`, `test_get_departments_reuses_checkpoint_loader` | ✅ PASS |
| AC4 | File saved for resumability | `test_save_hierarchical_json_*` (3 tests) | ✅ PASS |
| AC5 | Human-readable formatting | `test_save_hierarchical_json_success` (indentation check) | ✅ PASS |
| AC6 | Supports 3+ level hierarchies | `test_create_hierarchical_json_three_levels`, schema validation tests | ✅ PASS |

**Coverage Analysis**: All 6 ACs have dedicated test coverage with multiple test cases per AC. No gaps detected.

### Test Architecture Assessment

**Test Quality Score: 95/100**

**Strengths:**
- Excellent organization with class-based grouping by task
- Comprehensive fixtures for different hierarchy scenarios
- Clear, descriptive test names following Given-When-Then philosophy
- Proper mocking strategy (mocks external dependencies, tests actual logic)
- Edge case coverage (empty checkpoints, deserialization failures, missing files)
- Integration test validates full workflow

**Test Coverage Breakdown:**
- Task 1 (Load): 6 tests ← **Exceptional** error scenario coverage
- Task 2 (Summary): 3 tests ← Adequate
- Task 3 (Transform): 5 tests ← **Excellent** variety (flat/hierarchical/3-level)
- Task 4 (Validate): 3 tests ← Good coverage
- Task 5 (Parallel): 2 tests ← Sufficient
- Task 6 (Save): 3 tests ← Good coverage
- End-to-end: 1 test ← Validates integration

**Minor Enhancement Opportunities** (not required):
- Could add performance test for large datasets (1000+ departments) - useful for Epic 3 scaling
- Could test edge case where all departments have None/empty school names

### Security Review

**Status: PASS** ✅

- No credential handling - N/A
- File path validation present (uses Path, mkdir with parents=True)
- No SQL injection risks - pure Python data structures
- Input validation via Pydantic models
- JSON schema validation prevents malformed data
- Exception handling prevents information leakage
- No eval() or exec() usage

**Findings:** Zero security concerns.

### Performance Considerations

**Status: PASS** ✅

**Algorithmic Efficiency:**
- O(n) time complexity for all operations
- Efficient set comprehensions for uniqueness counting
- Single-pass iteration for hierarchy building
- JSON schema with `$ref` prevents duplication

**Memory Efficiency:**
- Loads all departments into memory (acceptable for expected dataset sizes: 10-500 departments typical)
- No memory leaks detected
- Proper cleanup with context managers

**I/O Efficiency:**
- File operations are atomic and infrequent
- JSON dumps with indent=2 adds minimal overhead for readability benefit
- Checkpoint reuse prevents redundant disk reads

**Scalability Note:** Current sync implementation is appropriate for story scope. When Epic 3 implements parallel professor discovery across departments, consider adding async file I/O for better concurrency.

### Non-Functional Requirements Validation

**Reliability (NFR12 - Resumability): EXCELLENT** ✅
- Checkpoint-based design enables full resumability
- Atomic file operations prevent partial writes
- Comprehensive error handling with actionable error messages
- Graceful degradation for missing university name

**Maintainability: EXCELLENT** ✅
- Clear code structure with single-responsibility methods
- Comprehensive logging for debugging
- Type hints enable IDE support and early error detection
- Self-documenting code with minimal complexity

**Usability: EXCELLENT** ✅
- Human-readable JSON output (indent=2)
- Clear error messages guide users to solutions
- Progress logged at key milestones

### Improvements Checklist

✅ **All improvements already implemented by dev team**:
- Comprehensive error handling ✅
- Full type annotations ✅
- Extensive test coverage ✅
- Standards compliance ✅

**Future Enhancements** (not blocking, low priority):
- [ ] Consider extracting university name resolution to separate `_resolve_university_name()` method for improved testability (current inline implementation works fine)
- [ ] Add performance benchmark test for 1000+ departments when Epic 3 parallelism is implemented
- [ ] Consider async file I/O when concurrent department processing begins in Epic 3 (current sync approach is intentional per story notes)

### Files Modified During Review

**None** - No code changes needed. Implementation is production-ready as-is.

### Gate Status

**Gate: PASS** → `docs/qa/gates/2.2-department-structure-json.yml`

**Quality Score: 100/100**

**Rationale:**
- All 6 acceptance criteria fully met
- 23/23 tests passing (100% success rate)
- Zero critical, high, or medium severity issues
- Exceeds coding standards
- Production-ready implementation
- Excellent test architecture

**Evidence:**
- Tests reviewed: 23 (all passing)
- Risks identified: 0 critical, 0 high, 0 medium, 0 low
- AC coverage: 6/6 (100%)
- Code quality: Exemplary

### Recommended Status

✅ **Ready for Done**

This story demonstrates exemplary software engineering practices and is immediately production-ready. The implementation is a model for future stories in this epic.

**Next Steps:**
1. Story owner: Update status to "Done"
2. Team: Use this implementation as reference for Stories 2.3, 3.1, etc.
3. No action required from dev team - code approved as-is
