# Story 5.4: Lab Member Publication Discovery

## Status

**Draft**

## Story

**As a** user,
**I want** publications by lab members (not just PI) identified,
**so that** I understand the full research output of the lab.

## Acceptance Criteria

1. Lab members identified from Epic 4 website scraping (FR16)
2. Publications retrieved for each lab member (last 3 years)
3. Co-authorship patterns analyzed (PI + members)
4. Member publication metrics aggregated to lab level
5. Handles missing member lists gracefully (will be addressed in 5.5)
6. Progress shows "Processing member X of Y for Lab Z"

## Tasks / Subtasks

- [ ] **Task 1: Load Lab Members** (AC: 1)
  - [ ] Get lab members from Lab.members (scraped in Epic 4)
  - [ ] If no members: Skip to Story 5.5 (inference)

- [ ] **Task 2: Query Publications for Each Member** (AC: 2)
  - [ ] Use paper-search-mcp
  - [ ] Query: author:{member_name} affiliation:{university}
  - [ ] Last 3 years

- [ ] **Task 3: Analyze Co-Authorship** (AC: 3)
  - [ ] Check if PI is co-author
  - [ ] Identify collaboration patterns

- [ ] **Task 4: Aggregate to Lab Level** (AC: 4)
  - [ ] Calculate lab total publications
  - [ ] Average relevance scores

## Dependencies

**Depends On:**
- **Epic 4 complete** (lab member lists from website scraping - AC 1)
- **Epic 5A complete** (PI publications for co-authorship analysis - AC 3)
- Story 1.5 complete (MCP server setup for publication retrieval)

**Convergence Point:**
This story is part of Epic 5B and can only execute **after both Epic 4 and Epic 5A complete**. The coordinator must validate both phases finished before starting Epic 5B.

**Blocks:**
- Story 5.5 (Lab Member Inference)
- Epic 6 (LinkedIn Integration)

## Testing

### Test Approach

**Unit Tests:**
- Lab member list loading from Epic 4 checkpoint
- MCP query construction for lab members
- Co-authorship pattern detection (PI + member on same paper)
- Publication metric aggregation (count, average relevance)
- Missing member list detection and handling
- Progress tracking message formatting

**Integration Tests:**
- End-to-end member publication retrieval for test lab
- Convergence validation (Epic 4 and 5A checkpoints exist)
- Co-authorship analysis across PI and member publications
- Lab-level metric aggregation

**Mocking Strategy:**
- Mock Epic 4 checkpoint (lab member lists) using test fixtures
- Mock Epic 5A checkpoint (PI publications) for co-authorship testing
- Mock paper-search-mcp responses for member queries
- Use pytest-mock for checkpoint manager

**Test Framework:**
- pytest 7.4.4
- pytest-asyncio 0.23.3 for async publication retrieval
- pytest-mock 3.12.0 for checkpoint and MCP mocking

### Key Test Scenarios

**1. Successful Member Publication Retrieval**
- Input: Lab with 5 members from Epic 4
- Expected: Publications retrieved for all 5 members
- Validates: AC 1, 2 - Lab members identified and publications retrieved

**2. Co-Authorship Pattern Detection**
- Input: PI and member both authors on same paper
- Expected: Paper flagged as co-authored, pattern recorded
- Validates: AC 3 - Co-authorship patterns analyzed

**3. Lab Metric Aggregation**
- Input: 3 members with 5, 3, 7 publications each (15 total)
- Expected: Lab total = 15, average relevance calculated
- Validates: AC 4 - Member metrics aggregated to lab level

**4. Missing Member List (Deferred to 5.5)**
- Input: Lab with empty Lab.members list
- Expected: Logged warning, skip to Story 5.5 for inference
- Validates: AC 5 - Missing member lists handled gracefully

**5. Convergence Validation**
- Input: Epic 4 complete, Epic 5A incomplete
- Expected: Error raised, Epic 5B blocked from starting
- Validates: Convergence point enforced

**6. Progress Tracking**
- Input: Lab "Smith Lab" with 4 members, processing 2nd member
- Expected: "Processing member 2 of 4 for Lab Smith Lab" displayed
- Validates: AC 6 - Progress shows member processing status

**7. Member with Zero Publications**
- Input: Lab member with no recent papers
- Expected: Empty result, logged, doesn't block processing
- Validates: Graceful handling of members without publications

**8. Co-Authorship with Multiple Lab Members**
- Input: Paper with PI + 2 lab members as co-authors
- Expected: All co-authorship relationships recorded
- Validates: Complex co-authorship pattern handling

### Success Criteria

- ✅ Publications retrieved for 100% of lab members (or gracefully skipped)
- ✅ Co-authorship patterns correctly identify PI-member collaborations
- ✅ Lab-level metrics accurately aggregate from all member publications
- ✅ Missing member lists don't crash processing
- ✅ Convergence validation prevents Epic 5B from starting early
- ✅ Progress tracking displays correct member count
- ✅ Checkpoint saved correctly for Epic 5B data
- ✅ Test coverage >75% for member publication retrieval functions

### Special Testing Considerations

**Convergence Validation Testing:**
```python
@pytest.mark.asyncio
async def test_convergence_validation_blocks_without_epic4(checkpoint_mgr):
    # Epic 4 incomplete
    checkpoint_mgr.phase_complete = Mock(side_effect=lambda phase: False if phase == "phase-4-labs" else True)

    coordinator = EpicCoordinator(checkpoint_mgr)

    with pytest.raises(IncompletePhaseError, match="Phase 4.*not complete"):
        await coordinator.start_epic_5b()

@pytest.mark.asyncio
async def test_convergence_validation_blocks_without_epic5a(checkpoint_mgr):
    # Epic 5A incomplete
    checkpoint_mgr.phase_complete = Mock(side_effect=lambda phase: False if phase == "phase-5a-pi-publications" else True)

    coordinator = EpicCoordinator(checkpoint_mgr)

    with pytest.raises(IncompletePhaseError, match="Phase 5A.*not complete"):
        await coordinator.start_epic_5b()

@pytest.mark.asyncio
async def test_convergence_validation_succeeds(checkpoint_mgr):
    # Both complete
    checkpoint_mgr.phase_complete = Mock(return_value=True)

    coordinator = EpicCoordinator(checkpoint_mgr)

    result = await coordinator.validate_convergence()
    assert result is True
```

**Lab Member Fixture:**
```python
@pytest.fixture
def lab_with_members():
    return Lab(
        id="lab-001",
        pi_name="Jane Smith",
        university="Stanford",
        members=[
            LabMember(name="Alice Johnson", role="PhD Student"),
            LabMember(name="Bob Chen", role="Postdoc"),
            LabMember(name="Carol Davis", role="PhD Student")
        ]
    )

@pytest.fixture
def pi_publications():
    # Load from Epic 5A checkpoint fixture
    return [
        Publication(
            title="AI for Robotics",
            authors=["Jane Smith", "Alice Johnson"],  # Co-authored with member
            year=2024
        ),
        Publication(
            title="Machine Learning Survey",
            authors=["Jane Smith"],  # PI only
            year=2024
        )
    ]
```

**Co-Authorship Analysis:**
```python
def test_coauthorship_detection(lab_with_members, pi_publications):
    agent = MemberPublicationAgent()

    patterns = agent.analyze_coauthorship(
        pi_pubs=pi_publications,
        members=lab_with_members.members
    )

    # Should detect PI + Alice Johnson collaboration
    assert ("Jane Smith", "Alice Johnson") in patterns
    assert patterns[("Jane Smith", "Alice Johnson")]["count"] == 1
```

**Aggregation Testing:**
- Test with varying publication counts per member
- Validate average relevance calculation
- Test total publication count across all members
- Handle members with zero publications in aggregation

**Missing Member List:**
- Create test lab with empty members list
- Verify logged warning contains lab name
- Verify processing continues to Story 5.5

**Progress Tracking:**
- Mock progress display function
- Verify format: "Processing member X of Y for Lab Z"
- Test with various member counts (1, 5, 10)

## Dev Notes

### Source Tree Location
- Modify: `src/agents/publication_retrieval.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
