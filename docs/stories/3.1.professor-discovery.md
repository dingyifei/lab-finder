# Story 3.1: Multi-Agent Professor Discovery

## Status

**Draft**

## Story

**As a** user,
**I want** professors identified across all relevant departments using parallel sub-agents,
**so that** discovery is efficient even for large universities.

## Acceptance Criteria

1. Sub-agents created for each department (or batch of departments) from Epic 2 output (FR10)
2. Professor directory pages discovered and scraped
3. Professor names, titles, department affiliations extracted
4. Lab affiliations identified where available
5. Research area descriptions extracted from directory listings
6. Built-in web tools used with Playwright fallback (NFR5)
7. Results aggregated from all sub-agents into master professor list

## Tasks / Subtasks

- [ ] **Task 1: Load Relevant Departments from Epic 2** (AC: 1)
  - [ ] Use checkpoint_manager to load `checkpoints/phase-1-relevant-departments.jsonl`
  - [ ] Deserialize to Department Pydantic models
  - [ ] Verify all departments have required fields (name, url)
  - [ ] Log: "Loaded X relevant departments for professor discovery"

- [ ] **Task 2: Create Professor Pydantic Model** (AC: 3, 4, 5)
  - [ ] Create `src/models/professor.py` module
  - [ ] Define Professor model:
    ```python
    class Professor(BaseModel):
        id: str  # Unique identifier (generated)
        name: str  # Full name
        title: str  # Academic title (Professor, Associate Professor, etc.)
        department_id: str  # Foreign key to Department
        department_name: str  # Department name for display
        school: Optional[str] = None  # School/college
        lab_name: Optional[str] = None  # Lab affiliation if available
        lab_url: Optional[str] = None  # Lab website URL
        research_areas: list[str] = []  # Research area descriptions
        profile_url: str  # Faculty profile URL
        email: Optional[str] = None  # Contact email if available
    ```
  - [ ] Add type hints and validation
  - [ ] Run mypy to verify type correctness

- [ ] **Task 3: Implement Professor Discovery Agent** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `src/agents/professor_discovery.py` module
  - [ ] Implement `discover_professors(department: Department) -> list[Professor]`
  - [ ] Discovery logic:
    - Identify professor directory page URL from department URL
    - Try built-in web tools first for scraping
    - Fallback to Playwright if built-in tools fail
    - Extract professor cards/entries from directory
    - Parse: name, title, department, lab affiliation, research areas, profile URL
  - [ ] Handle multiple directory page formats (tables, cards, lists)
  - [ ] Add retry logic with tenacity (3 retries, exponential backoff)

- [ ] **Task 4: Spawn Sub-Agents for Parallel Discovery** (AC: 1, 7)
  - [ ] Implement hierarchical coordinator pattern from architecture
  - [ ] For each batch of departments (from Story 2.5 batch config):
    - Spawn sub-agent per department for parallel professor discovery
    - Each sub-agent calls `discover_professors(department)`
    - Aggregate results from all sub-agents
  - [ ] Handle sub-agent failures gracefully (continue with partial results)
  - [ ] Log sub-agent spawning: "Spawned X sub-agents for professor discovery"

- [ ] **Task 5: Handle Multiple Directory Page Formats** (AC: 2)
  - [ ] Implement selector fallback strategy:
    - Try common selectors: `.faculty-member`, `.professor-card`, `table.faculty`
    - Try semantic HTML: `<article>`, `<section class="people">`
    - Try link patterns: `<a href="*/faculty/*">`, `<a href="*/people/*">`
  - [ ] If structured directory not found: Search for "faculty" or "people" links on department page
  - [ ] Log which selector pattern succeeded
  - [ ] Flag departments where discovery failed with data quality flag

- [ ] **Task 6: Extract Research Areas from Directory** (AC: 5)
  - [ ] Look for research area indicators:
    - Explicit "Research Areas:" sections
    - Keywords in bio/description text
    - Subject tags or labels
  - [ ] Parse research areas into list
  - [ ] Clean and normalize area names (remove punctuation, standardize)
  - [ ] Handle missing research areas (empty list, not failure)

- [ ] **Task 7: Aggregate and Deduplicate Professor Results** (AC: 7)
  - [ ] Aggregate professor lists from all sub-agents
  - [ ] Deduplicate by professor name + department combination
  - [ ] Use LLM-based name matching for fuzzy duplicates
  - [ ] If duplicates found: Merge information (prefer more complete records)
  - [ ] Generate unique ID for each professor (hash of name + department)

- [ ] **Task 8: Save Professor List to Checkpoint** (AC: 7)
  - [ ] Use checkpoint_manager.save_batch()
  - [ ] Save to `checkpoints/phase-2-professors-batch-{N}.jsonl`
  - [ ] Use JSONL format for streaming support
  - [ ] Serialize Professor models with `.model_dump()`
  - [ ] Log: "Discovered X professors across Y departments"

- [ ] **Task 9: Integrate Progress Tracking** (AC: 1)
  - [ ] Use progress_tracker from Story 1.7
  - [ ] Display: "Phase 2: Professor Discovery [X/Y departments processed]"
  - [ ] Show batch progress: "Batch M: Processing departments A-B"
  - [ ] Display ETA for discovery completion
  - [ ] Final summary: "Phase 2 complete: X professors discovered"

## Dev Notes

### Relevant Architecture Information

**Component:** Professor Discovery Agent (Epic 3)

**Responsibility:** Discover professors across filtered departments; extract profile and research data (Epic 3: FR10)

**Key Interfaces:**
- `discover_professors(department: Department) -> list[Professor]` - Scrape professor directory for department

**Dependencies:**
- Department data from Epic 2 checkpoints
- Claude Agent SDK built-in web tools (primary)
- Playwright (fallback for JS-heavy pages)
- Checkpoint Manager for saving professor data
- Progress Tracker for status updates

**Technology Stack:**
- Claude Agent SDK web fetch tools
- Playwright 1.40.0 as fallback
- structlog with phase context
- Pydantic Professor model

**Agent Pattern:** Hierarchical coordinator spawns sub-agents per department for parallel discovery; coordinator aggregates results

**Source Tree Location:**
- Create: `src/agents/professor_discovery.py`
- Create: `src/models/professor.py`
- Load from: `checkpoints/phase-1-relevant-departments.jsonl`
- Save to: `checkpoints/phase-2-professors-batch-{N}.jsonl`

**Professor Model Schema:**
```python
class Professor(BaseModel):
    id: str  # Unique identifier (UUID or hash)
    name: str  # Full name
    title: str  # Academic title
    department_id: str  # Links to Department.id
    department_name: str  # For display
    school: Optional[str] = None  # Parent school
    lab_name: Optional[str] = None  # Lab affiliation
    lab_url: Optional[str] = None  # Lab website
    research_areas: list[str] = []  # Research keywords
    profile_url: str  # Faculty profile URL
    email: Optional[str] = None  # Contact email
    data_quality_flags: list[str] = []  # Quality issues
```

**Web Scraping Strategy (from Architecture):**
- **Tiered Fallback:** Built-in → Playwright → Skip with Flag
- Try Claude Agent SDK built-in tools first
- Fallback to Playwright for JS-heavy pages
- Skip with data quality flag if both fail

**Common Directory Page Patterns:**
1. **Faculty List Table:** `<table>` with rows per professor
2. **Card Grid:** `<div class="faculty-card">` with profile cards
3. **Alphabetical List:** `<ul>` or `<ol>` with professor entries
4. **Search-Based:** Dynamic directory requiring search interaction

**Selector Fallback Strategy:**
```python
SELECTOR_PATTERNS = [
    # Pattern 1: Semantic classes
    '.faculty-member', '.professor-card', '.people-item',
    # Pattern 2: Structural containers
    'article.faculty', 'section.people', 'div.directory-entry',
    # Pattern 3: Tables
    'table.faculty tr', 'table.directory tr',
    # Pattern 4: Generic containers with links
    'a[href*="/faculty/"]', 'a[href*="/people/"]', 'a[href*="/profile/"]'
]
```

**Error Handling Pattern:**
- Retry Policy: Exponential backoff (max 3 retries, 1s initial delay)
- Timeout: 30 seconds per page
- Failures: Flag department with data quality issue, continue
- Missing data: Use empty values, don't fail entire discovery

**Critical Rules (from Coding Standards):**
- Web scraping must try built-in tools first
- Always type hint function signatures
- Never use print() for logging (use structlog)
- Use checkpoint_manager.save_batch() - never write JSONL directly

**Architecture Component Diagram Flow:**
```
CLI Coordinator → Professor Discovery Agent (coordinator)
Professor Discovery Agent → Sub-Agents (spawned per department)
Sub-Agents → Web Scraping (built-in tools → Playwright fallback)
Professor Discovery Agent → Aggregator (deduplicate, merge)
Professor Discovery Agent → Checkpoint Manager (save batches)
Professor Discovery Agent → Progress Tracker (display progress)
```

### Testing

**Test File Location:** `tests/integration/test_professor_discovery.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Integration tests with mock HTML fixtures
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Unit test for Professor model validation
2. Integration test with mock professor directory HTML
3. Test web scraping fallback (built-in failure → Playwright success)
4. Test multiple directory format handling (table, cards, list)
5. Test sub-agent spawning and aggregation
6. Test deduplication of professor records
7. Test checkpoint saving (verify JSONL format)

**Example Test Pattern:**
```python
def test_discover_professors_with_mock_directory(tmp_path):
    # Arrange
    department = Department(id="dept-1", name="CS", url="https://cs.edu",
                           hierarchy_level=1)
    mock_html = """
    <div class="faculty-member">
        <h3>Dr. Jane Smith</h3>
        <p class="title">Associate Professor</p>
        <p class="research">Machine Learning, AI</p>
        <a href="/profile/jane-smith">Profile</a>
    </div>
    """
    # Mock web fetch to return mock_html

    agent = ProfessorDiscoveryAgent()

    # Act
    professors = agent.discover_professors(department)

    # Assert
    assert len(professors) > 0
    assert professors[0].name == "Dr. Jane Smith"
    assert professors[0].title == "Associate Professor"
    assert "Machine Learning" in professors[0].research_areas
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
