# Story 8.4: Detailed Individual Lab Reports

## Status

**Draft**

## Story

**As a** user,
**I want** detailed reports for each lab in a dedicated directory,
**so that** I can deep-dive into specific labs of interest.

## Acceptance Criteria

1. Individual lab report generated for each analyzed lab (FR29)
2. Reports saved to ./labs/ directory
3. Each report includes: PI profile, lab overview, recent publications (with abstracts), lab members, authorship analysis, collaboration network, fitness scoring breakdown, contact information, data quality flags
4. Reports named consistently (e.g., labs/PI-name-department.md)
5. Internal links from Overview.md to detailed reports
6. Markdown formatting for readability
7. Reports self-contained (can be read independently)

## Tasks / Subtasks

- [ ] **Task 1: Generate Report for Each Lab** (AC: 1, 3)
  - [ ] Create comprehensive lab report
  - [ ] Include all required sections

- [ ] **Task 2: Save to labs/ Directory** (AC: 2, 4)
  - [ ] Create `output/labs/` directory
  - [ ] Save reports with consistent naming

- [ ] **Task 3: Link from Overview** (AC: 5)
  - [ ] Add links in Overview.md
  - [ ] Link to detailed reports

- [ ] **Task 4: Format for Readability** (AC: 6, 7)
  - [ ] Use markdown formatting
  - [ ] Make reports self-contained

## Dev Notes

### Source Tree Location
- Modify: `src/agents/report_generator.py`
- Create: `output/labs/` directory
- Create: `output/labs/{pi-name}-{department}.md` for each lab

### Dependencies
- Generates individual reports that are linked from Overview.md (Story 8.1)

### Input Data
- Lab data from: `checkpoints/phase-7-fitness-scores.jsonl`
- Each FitnessScore contains complete Lab object with all Epic 1-7 data

### Report File Naming
- Format: `labs/{PI-lastname}-{department-abbrev}.md`
- Example: `labs/smith-bioeng.md`, `labs/jones-cs.md`
- Sanitize names: lowercase, remove special characters, replace spaces with hyphens

### Link Format from Overview.md
- Relative markdown links: `[Dr. Smith - Bioengineering](./labs/smith-bioeng.md)`
- Place links in ranked lab list next to each PI name

### Detailed Section Specifications

#### 1. PI Profile
- **Name and Title:** Dr. [Name], [Title]
- **Department:** [Department], [School/Division if applicable]
- **Email:** [email] (if available)
- **Research Interests:** Extracted from directory or website (bullet list)
- **Lab Website:** [URL] (with last updated date)

#### 2. Lab Overview
- **Description:** Lab mission/focus from website (2-3 sentences)
- **Team Size:** Number of lab members identified
- **Website Status:** Last updated [date] OR Last seen [date via Archive.org] OR ❌ Unavailable
- **Active Research Areas:** Top 3-5 areas from website or publication analysis

#### 3. Recent Publications (Last 3 Years)
- **Format:** Reverse chronological list
- **Include:** Title, Authors (highlight PI and lab members), Journal, Year
- **Abstracts:** Show first 200 chars with "..." or full if short
- **Max Display:** Top 10 publications (sorted by journal reputation)
- **Source:** Epic 5 publication data

#### 4. Lab Members
- **Current Members:** List from website scraping (Epic 4)
  - Format: Name (Role) - e.g., "Jane Doe (PhD Candidate)"
- **Inferred Members:** If website unavailable, list inferred from co-authorship (Epic 5B)
  - Flag with: ⚠️ Inferred from co-authorship
- **LinkedIn Matches:** Show confidence scores for matched members (Epic 6)
  - Format: Name (Role) - LinkedIn: ✓ (confidence: 85%)

#### 5. Authorship Analysis
- **First Author Publications:** Count and percentage (e.g., "8/15 (53%)")
- **Last Author Publications:** Count and percentage (PI often last author)
- **Middle Author Publications:** Count and percentage
- **Core vs. Collaborator Assessment:** Text summary from Epic 7
  - Example: "Core research driver - 70% first/last author positions"

#### 6. Collaboration Network
- **Format:** Bulleted list of frequent collaborators
- **Include:** Collaborator name, institution, number of joint publications
- **Example:**
  ```markdown
  - Dr. Johnson (MIT) - 5 joint publications
  - Dr. Lee (Stanford) - 3 joint publications
  ```
- **Source:** Epic 7 collaboration identification

#### 7. Fitness Scoring Breakdown
- **Overall Score:** X/100
- **Per-Criterion Scores:** Table showing each criterion, weight, and score
  ```markdown
  | Criterion | Weight | Score | Notes |
  |-----------|--------|-------|-------|
  | Research Alignment | 30% | 85 | Strong ML focus |
  | Publication Quality | 25% | 90 | Top-tier journals |
  | Position Availability | 20% | 100 | PhD graduating May 2025 |
  | Website Freshness | 15% | 70 | Updated 6 months ago |
  | Collaboration Activity | 10% | 80 | Active network |
  ```
- **Rationale:** 2-3 sentence explanation from Epic 7 LLM scoring

#### 8. Contact Information
- **Email:** [email]
- **Contact Form:** [URL if available]
- **Application/Prospective Student URL:** [URL if available]
- **Office Location:** [if available from website]

#### 9. Data Quality Flags
- **All Flags for This Lab:** List from Epic 4-7 processing
- **Format:** Emoji + description (see Story 8.5)
- **Example:**
  ```markdown
  - ⚠️ Lab members inferred from co-authorship (website unavailable)
  - ℹ️ Website last updated 8 months ago
  ```

### Self-Contained vs. Brief Balance
- Each report should be **self-contained** (readable independently without PRD/Architecture)
- Include enough detail to make decisions, but keep sections concise
- Use bullet points and tables for scannability
- Aim for 2-4 pages per lab report when rendered

## Testing

### Testing Approach
- **Unit Tests:** Individual section generation functions, file naming sanitization
- **Integration Tests:** Complete lab report generation from Lab object, link generation

### Key Test Scenarios
1. **Happy Path:** Lab with complete data across all 9 sections, verify all sections populated
2. **Edge Case - Missing Website:** Lab with no website, verify inferred members shown with flags
3. **Edge Case - No Publications:** Lab with no publications found, verify graceful handling
4. **Edge Case - No LinkedIn Matches:** Lab members without LinkedIn data, verify appropriate display
5. **Edge Case - Missing Contact Info:** Lab with no email/contact form, verify section handles gracefully
6. **Validation:** All 9 sections present in every report
7. **Validation:** Links from Overview.md work correctly (relative paths)
8. **Validation:** File names sanitized correctly (no special characters, spaces)
9. **Format Validation:** Markdown tables render correctly, bullet lists formatted properly

### Success Criteria
- All 9 required sections present in each lab report
- Reports saved to `output/labs/` with consistent naming
- Links from Overview.md functional (clicking navigates to correct report)
- Reports are self-contained and readable independently
- Missing data handled gracefully with appropriate flags
- Markdown formatting renders correctly in viewers

## References

### Related Documentation
- **PRD:** Epic 8 Detailed Lab Reports (docs/prd.md:849-862)
- **Architecture:** Report Generator component (docs/architecture.md:1307-1319)

### Dependencies
- **Story 8.1:** Overview.md creation (for link insertion)
- **Epic 7:** Fitness scoring (provides scoring breakdown data)
- **Epic 6:** LinkedIn Integration (provides member matches and position signals)
- **Epic 5:** Publication Research (provides PI and member publications)
- **Epic 4:** Lab Intelligence (provides website, members, contact info)

### Data Sources
- Complete lab data: `checkpoints/phase-7-fitness-scores.jsonl`
- Lab object contains aggregated data from all epics:
  - `lab.pi_info`: PI name, title, department, email
  - `lab.website_status`: URL, last_updated, archive_org_snapshots
  - `lab.publications`: List of Publication objects with abstracts
  - `lab.members`: List of LabMember objects (from website or inferred)
  - `lab.linkedin_matches`: List of matched profiles with confidence
  - `lab.authorship_analysis`: First/last/middle author counts
  - `lab.collaborations`: List of Collaborator objects
  - `lab.contact_info`: Email, forms, application URLs
  - `lab.data_quality_flags`: List of flag objects

### Report Template Structure
```markdown
# [PI Name] - [Department]

## PI Profile
[Section 1 content]

## Lab Overview
[Section 2 content]

## Recent Publications
[Section 3 content]

## Lab Members
[Section 4 content]

## Authorship Analysis
[Section 5 content]

## Collaboration Network
[Section 6 content]

## Fitness Scoring Breakdown
[Section 7 content]

## Contact Information
[Section 8 content]

## Data Quality Notes
[Section 9 content]
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
