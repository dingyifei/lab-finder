# Story 6.4: PhD Graduation & Departure Detection

## Status

**Draft**

## Story

**As a** user,
**I want** graduating and recently departed PhD students identified,
**so that** I can target labs with upcoming position openings.

## Acceptance Criteria

1. LinkedIn profiles analyzed for entry year/start date (FR21)
2. Configured average graduation duration used (FR5, e.g., 5.5 years)
3. Expected graduation year calculated (entry year + duration)
4. Currently graduating PhDs identified (within next year)
5. Recently departed PhDs identified (graduated within last year)
6. Timeline uncertainty acknowledged (some variation in graduation timing)
7. Position availability signals saved for fitness scoring

## Tasks / Subtasks

- [ ] **Task 1: Extract Entry Year from LinkedIn** (AC: 1)
  - [ ] Parse education section from LinkedIn profile
  - [ ] Extract PhD start date (year only)
  - [ ] Store in `LabMember.entry_year`
  - [ ] If entry year missing:
    - Log warning with member name
    - Set `entry_year = None`
    - Add flag: `"missing_entry_year"`
    - Skip graduation calculations for this member

- [ ] **Task 2: Calculate Expected Graduation** (AC: 2, 3)
  - [ ] Load avg_phd_duration from config.json (`avg_phd_duration`, default: 5.5 years)
  - [ ] Get current year from system time: `datetime.now().year`
  - [ ] Calculate: `expected_graduation_year = entry_year + avg_phd_duration`
  - [ ] Round to nearest integer year
  - [ ] Store in `LabMember.expected_graduation_year`
  - [ ] Handle edge cases:
    - If `entry_year is None`: Skip calculation, set `expected_graduation_year = None`
    - If calculated year is in the past (< current_year - 2): Flag as `"phd_overdue"` (may have already graduated)

- [ ] **Task 3: Identify Graduating Students** (AC: 4)
  - [ ] Get current year: `current_year = datetime.now().year`
  - [ ] Check if `expected_graduation_year` is within next year:
    - `current_year <= expected_graduation_year <= current_year + 1`
  - [ ] If yes:
    - Set `position_status = "graduating"`
    - Add flag: `"graduating_soon"`
  - [ ] Log: "Graduating student identified: {name}, expected {year}"

- [ ] **Task 4: Identify Recent Departures** (AC: 5)
  - [ ] Get current year: `current_year = datetime.now().year`
  - [ ] Check if `expected_graduation_year` was within last year:
    - `current_year - 1 <= expected_graduation_year < current_year`
  - [ ] If yes:
    - Set `position_status = "departed"`
    - Add flag: `"recently_departed"`
  - [ ] Log: "Recent departure detected: {name}, graduated ~{year}"

- [ ] **Task 5: Update LabMember Model** (AC: 1, 3, 7)
  - [ ] Add fields:
    ```python
    entry_year: Optional[int] = None
    expected_graduation_year: Optional[int] = None
    position_status: str = "unknown"  # active/graduating/departed
    ```

## Dev Notes

### Source Tree Location
- Modify: `src/agents/linkedin_matcher.py`
- Modify: `src/models/lab_member.py`
- Use: `src/utils/logger.py` (from Story 1.7)

### Current Year Source

**Source:** Python `datetime` module

```python
from datetime import datetime

current_year = datetime.now().year  # e.g., 2025
```

**Usage:** Current year is the reference point for all graduation calculations.

### Graduation Calculation Logic

```python
from datetime import datetime
from src.utils.logger import get_logger
from src.models.lab_member import LabMember

logger = get_logger(correlation_id=run_id, phase="graduation_detection", component="linkedin_matcher")

def calculate_graduation_status(member: LabMember, avg_phd_duration: float = 5.5) -> LabMember:
    """
    Calculate expected graduation year and position status.

    Args:
        member: LabMember with entry_year populated
        avg_phd_duration: Average PhD duration in years (from config)

    Returns:
        Updated LabMember with graduation data
    """
    current_year = datetime.now().year

    # Edge case: Missing entry year
    if member.entry_year is None:
        logger.warning("Missing entry year", member=member.name)
        member.data_quality_flags.append("missing_entry_year")
        member.position_status = "unknown"
        return member

    # Calculate expected graduation
    expected_grad = int(member.entry_year + avg_phd_duration)
    member.expected_graduation_year = expected_grad

    # Edge case: Overdue PhD (calculated graduation > 2 years ago)
    if expected_grad < current_year - 2:
        logger.warning("PhD possibly overdue", member=member.name, expected_year=expected_grad)
        member.data_quality_flags.append("phd_overdue")

    # Identify graduating students
    if current_year <= expected_grad <= current_year + 1:
        member.position_status = "graduating"
        member.data_quality_flags.append("graduating_soon")
        logger.info("Graduating student", member=member.name, year=expected_grad)

    # Identify recent departures
    elif current_year - 1 <= expected_grad < current_year:
        member.position_status = "departed"
        member.data_quality_flags.append("recently_departed")
        logger.info("Recent departure", member=member.name, year=expected_grad)

    # Active student
    elif expected_grad > current_year + 1:
        member.position_status = "active"

    # Likely already departed
    else:
        member.position_status = "likely_departed"

    return member
```

### Edge Cases Handling

**1. Missing Entry Year:**
- **Cause:** LinkedIn profile doesn't list PhD start date
- **Handling:** Set `entry_year = None`, flag `"missing_entry_year"`, skip calculations
- **Impact:** Position status remains `"unknown"`, no graduation predictions

**2. Overdue PhD (Expected graduation > 2 years ago):**
- **Cause:** Student taking longer than average, or already graduated but still listed
- **Handling:** Flag `"phd_overdue"`, position status depends on timeline
- **Impact:** Signals data may be stale or student delayed

**3. Non-Standard Duration:**
- **Cause:** Some programs are 4 years, others 6-7 years
- **Handling:** Use configurable `avg_phd_duration` (default 5.5)
- **Impact:** Some predictions will be off by 1-2 years (acceptable uncertainty)

**4. Entry Year in Future:**
- **Cause:** Data error or incoming student
- **Handling:** Log warning, position status = "incoming" or "active"
- **Impact:** No graduation soon or recent departure flags

### Configuration

**Config Source:** `config.json`

```json
{
  "avg_phd_duration": 5.5
}
```

**Loading:**
```python
from src.utils.config_loader import load_config

config = load_config("config.json")
avg_phd_duration = config.get("avg_phd_duration", 5.5)
```

### Testing

**Test File Location:** `tests/unit/test_graduation_detection.py`

**Test Approach:** Unit tests with various timeline scenarios

**Key Test Scenarios:**

1. **Graduating Student Detection** (Unit)
   - Arrange: Member with entry_year=2020, current_year=2025, avg_duration=5.5
   - Expected graduation = 2025 (within next year)
   - Assert `position_status = "graduating"`
   - Assert `"graduating_soon"` in flags

2. **Recent Departure Detection** (Unit)
   - Arrange: Member with entry_year=2019, current_year=2025, avg_duration=5.5
   - Expected graduation = 2024 (last year)
   - Assert `position_status = "departed"`
   - Assert `"recently_departed"` in flags

3. **Active Student** (Unit)
   - Arrange: Member with entry_year=2022, current_year=2025, avg_duration=5.5
   - Expected graduation = 2027 (more than 1 year away)
   - Assert `position_status = "active"`
   - Assert no graduation/departure flags

4. **Missing Entry Year** (Unit - Edge Case)
   - Arrange: Member with entry_year=None
   - Call `calculate_graduation_status()`
   - Assert `position_status = "unknown"`
   - Assert `"missing_entry_year"` in flags
   - Assert `expected_graduation_year = None`

5. **Overdue PhD** (Unit - Edge Case)
   - Arrange: Member with entry_year=2015, current_year=2025, avg_duration=5.5
   - Expected graduation = 2020 (5 years ago, overdue)
   - Assert `"phd_overdue"` in flags
   - Assert `position_status = "likely_departed"`

6. **Current Year Calculation** (Unit)
   - Mock `datetime.now()` to return known year (2025)
   - Call graduation detection
   - Verify calculations use mocked year correctly

7. **Non-Standard Duration** (Unit - Edge Case)
   - Test with avg_duration=4.0 (shorter program)
   - Test with avg_duration=7.0 (longer program)
   - Verify calculations adjust appropriately

**Success Criteria:**
- Graduation timeline calculations are accurate
- Edge cases (missing data, overdue PhDs) handled gracefully
- Position status correctly assigned based on timeline
- Flags appropriately added for each scenario

**Test Data Requirements:**
- LabMember fixtures with various entry years
- Mock current year for reproducible tests
- Configuration with different avg_phd_duration values

**Example Test Pattern:**
```python
import pytest
from datetime import datetime
from unittest.mock import patch
from src.agents.linkedin_matcher import calculate_graduation_status
from src.models.lab_member import LabMember

def test_graduating_student_detected():
    # Arrange
    member = LabMember(name="Jane Doe", entry_year=2020)

    with patch('src.agents.linkedin_matcher.datetime') as mock_datetime:
        mock_datetime.now.return_value = datetime(2025, 10, 6)

        # Act
        result = calculate_graduation_status(member, avg_phd_duration=5.5)

        # Assert
        assert result.expected_graduation_year == 2025  # 2020 + 5.5 = 2025
        assert result.position_status == "graduating"
        assert "graduating_soon" in result.data_quality_flags

def test_missing_entry_year_handled():
    # Arrange
    member = LabMember(name="John Doe", entry_year=None)

    # Act
    result = calculate_graduation_status(member)

    # Assert
    assert result.expected_graduation_year is None
    assert result.position_status == "unknown"
    assert "missing_entry_year" in result.data_quality_flags
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-06 | 0.2 | Added current year source, edge case handling, graduation calculation logic, testing guidance | Sarah (PO) |
