# Story 1.3: Credential Management with CLI Prompts

**Epic:** Epic 1 - Foundation & Configuration Infrastructure

**Status:** Not Started

---

## User Story

As a **user**,
I want **the system to prompt me for missing credentials and save them securely**,
so that **I don't have to manually edit configuration files or re-enter credentials on each run**.

---

## Acceptance Criteria

1. System checks for required credentials (LinkedIn, university portal if needed) at startup (FR2)
2. CLI prompts appear for missing credentials with clear instructions (FR3)
3. Credentials saved to `.env` file with appropriate file permissions (600/rw-------)
4. Existing credentials loaded from `.env` without prompting
5. Option to update/refresh stored credentials via `--update-credentials` flag
6. Credentials never logged or displayed in plain text (masked in all output)
7. Credential manager utility created in `src/utils/credential_manager.py`

---

## Technical Details

### Credentials Required

Based on PRD requirements:

1. **LinkedIn Credentials (Required for Epic 6):**
   - `LINKEDIN_EMAIL` - LinkedIn account email
   - `LINKEDIN_PASSWORD` - LinkedIn account password

2. **Optional University Portal Credentials:**
   - `UNIVERSITY_USERNAME` - If university directory requires authentication
   - `UNIVERSITY_PASSWORD` - If university directory requires authentication

3. **System Configuration:**
   - `LOG_LEVEL` - Optional logging level (default: INFO)

### .env File Structure

```env
# LinkedIn Credentials (Required for Epic 6: LinkedIn Integration)
LINKEDIN_EMAIL=user@example.com
LINKEDIN_PASSWORD=secure_password_here

# Optional University Portal Credentials
# Uncomment if your target university requires authentication
# UNIVERSITY_USERNAME=your_username
# UNIVERSITY_PASSWORD=your_password

# System Configuration
LOG_LEVEL=INFO
```

### Credential Manager Module

Create `src/utils/credential_manager.py`:

```python
"""
Credential Manager Module
Handles secure credential storage and retrieval with CLI prompts.
"""

import os
from pathlib import Path
from typing import Dict, Optional

from dotenv import load_dotenv, set_key
from rich.console import Console
from rich.prompt import Prompt, Confirm

console = Console()

class CredentialManager:
    """Manages credentials with secure storage and CLI prompting."""

    def __init__(self, env_file: Path = Path(".env")):
        """
        Initialize credential manager.

        Args:
            env_file: Path to .env file for credential storage
        """
        self.env_file = env_file
        self._load_credentials()

    def _load_credentials(self) -> None:
        """Load existing credentials from .env file."""
        if self.env_file.exists():
            load_dotenv(self.env_file)
            self._set_secure_permissions()
        else:
            # Create .env from .env.example if it doesn't exist
            example_file = Path(".env.example")
            if example_file.exists():
                console.print(
                    f"[yellow]â„¹ï¸  No .env file found. Creating from .env.example...[/yellow]"
                )
                self.env_file.write_text(example_file.read_text(encoding="utf-8"))
                self._set_secure_permissions()

    def _set_secure_permissions(self) -> None:
        """Set secure file permissions on .env file (Unix only)."""
        if os.name != 'nt':  # Not Windows
            try:
                os.chmod(self.env_file, 0o600)  # rw------- (owner read/write only)
            except Exception as e:
                console.print(
                    f"[yellow]âš ï¸  Could not set secure permissions on .env: {e}[/yellow]"
                )

    def get_credential(
        self,
        key: str,
        prompt_message: str,
        is_password: bool = False,
        required: bool = True
    ) -> Optional[str]:
        """
        Get credential from environment or prompt user.

        Args:
            key: Environment variable name (e.g., "LINKEDIN_EMAIL")
            prompt_message: Message to display when prompting
            is_password: Whether to mask input (for passwords)
            required: Whether credential is required

        Returns:
            Credential value or None if optional and not provided

        Raises:
            ValueError: If required credential not provided
        """
        # Check if credential already exists
        value = os.getenv(key)
        if value:
            return value

        # Prompt user for credential
        console.print(f"\n[yellow]ðŸ”‘ Credential Required: {key}[/yellow]")
        console.print(f"   {prompt_message}\n")

        if is_password:
            value = Prompt.ask("   Enter value", password=True)
        else:
            value = Prompt.ask("   Enter value")

        if not value and required:
            raise ValueError(f"Required credential not provided: {key}")

        if value:
            # Save to .env file
            self._save_credential(key, value)

        return value or None

    def _save_credential(self, key: str, value: str) -> None:
        """
        Save credential to .env file.

        Args:
            key: Environment variable name
            value: Credential value
        """
        try:
            set_key(self.env_file, key, value)
            os.environ[key] = value  # Update current environment
            console.print(f"   [green]âœ… Saved {key} to .env[/green]\n")
        except Exception as e:
            console.print(f"   [red]âŒ Failed to save credential: {e}[/red]\n")
            raise

    def check_required_credentials(
        self,
        require_linkedin: bool = False
    ) -> Dict[str, str]:
        """
        Check for required credentials and prompt if missing.

        Args:
            require_linkedin: Whether LinkedIn credentials are required
                             (True for Epic 6, False for earlier epics)

        Returns:
            Dictionary of all credentials

        Raises:
            ValueError: If required credentials are missing after prompting
        """
        console.print("\nðŸ” Checking credentials...\n")

        credentials = {}

        # LinkedIn credentials (required for Epic 6)
        if require_linkedin:
            credentials["LINKEDIN_EMAIL"] = self.get_credential(
                "LINKEDIN_EMAIL",
                "LinkedIn email address for profile matching (Epic 6)",
                is_password=False,
                required=True
            )
            credentials["LINKEDIN_PASSWORD"] = self.get_credential(
                "LINKEDIN_PASSWORD",
                "LinkedIn password (stored securely in .env)",
                is_password=True,
                required=True
            )
        else:
            console.print("[dim]â„¹ï¸  LinkedIn credentials not required for this epic[/dim]\n")

        # Optional university portal credentials
        needs_university_auth = Confirm.ask(
            "Does your target university require authentication for directory access?",
            default=False
        )

        if needs_university_auth:
            credentials["UNIVERSITY_USERNAME"] = self.get_credential(
                "UNIVERSITY_USERNAME",
                "University portal username",
                is_password=False,
                required=True
            )
            credentials["UNIVERSITY_PASSWORD"] = self.get_credential(
                "UNIVERSITY_PASSWORD",
                "University portal password",
                is_password=True,
                required=True
            )

        console.print("[green]âœ… All required credentials present[/green]\n")
        return credentials

    def update_credentials(self) -> None:
        """Prompt user to update all credentials."""
        console.print("\nðŸ”„ Update Credentials\n")

        # LinkedIn
        if Confirm.ask("Update LinkedIn credentials?", default=False):
            self.get_credential(
                "LINKEDIN_EMAIL",
                "New LinkedIn email",
                is_password=False,
                required=True
            )
            self.get_credential(
                "LINKEDIN_PASSWORD",
                "New LinkedIn password",
                is_password=True,
                required=True
            )

        # University
        if Confirm.ask("Update university portal credentials?", default=False):
            self.get_credential(
                "UNIVERSITY_USERNAME",
                "New university username",
                is_password=False,
                required=False
            )
            self.get_credential(
                "UNIVERSITY_PASSWORD",
                "New university password",
                is_password=True,
                required=False
            )

        console.print("[green]âœ… Credentials updated[/green]\n")

    @staticmethod
    def mask_credential(value: str, show_chars: int = 3) -> str:
        """
        Mask credential for display in logs.

        Args:
            value: Credential value to mask
            show_chars: Number of characters to show at start

        Returns:
            Masked credential (e.g., "abc***")
        """
        if not value or len(value) <= show_chars:
            return "***"
        return f"{value[:show_chars]}{'*' * (len(value) - show_chars)}"
```

### CLI Integration

Update main CLI entry point to check credentials:

```python
# In src/main.py or CLI coordinator

import argparse
from pathlib import Path
from src.utils.credential_manager import CredentialManager

def main():
    parser = argparse.ArgumentParser(description="Lab Finder CLI")
    parser.add_argument(
        "--update-credentials",
        action="store_true",
        help="Update stored credentials"
    )
    parser.add_argument(
        "--require-linkedin",
        action="store_true",
        help="Require LinkedIn credentials (for Epic 6)"
    )
    args = parser.parse_args()

    # Initialize credential manager
    cred_manager = CredentialManager()

    # Handle credential updates
    if args.update_credentials:
        cred_manager.update_credentials()
        return

    # Check required credentials
    credentials = cred_manager.check_required_credentials(
        require_linkedin=args.require_linkedin
    )

    # Continue with main application logic...
```

### Security Best Practices

1. **File Permissions:**
   - .env file set to 600 (rw-------)
   - Only owner can read/write

2. **Never Log Credentials:**
   - Use `CredentialManager.mask_credential()` for any logging
   - Structlog filters should mask password fields

3. **Git Ignore:**
   - .env file already in .gitignore
   - Only .env.example committed to repo

4. **MCP Server Configuration:**
   - Note: LinkedIn credentials for mcp-linkedin server are configured separately
   - This story handles credentials for optional Playwright fallback

### Updated .env.example

```env
# Lab Finder Credentials
# Copy this file to .env and fill in your actual credentials
# NEVER commit .env to git (it's in .gitignore)

# ============================================================================
# LinkedIn Credentials (Required for Epic 6: LinkedIn Integration)
# ============================================================================
# Used by mcp-linkedin MCP server for profile matching
# Configure these in your MCP server settings as well
LINKEDIN_EMAIL=your-linkedin-email@example.com
LINKEDIN_PASSWORD=your-secure-password

# ============================================================================
# Optional University Portal Credentials
# ============================================================================
# Only needed if your target university requires authentication
# for faculty directory or department pages
# UNIVERSITY_USERNAME=your-university-username
# UNIVERSITY_PASSWORD=your-university-password

# ============================================================================
# System Configuration
# ============================================================================
LOG_LEVEL=INFO
```

---

## Implementation Steps

1. **Update .env.example:**
   - Add LinkedIn credential fields
   - Add optional university credential fields
   - Add helpful comments

2. **Create credential manager module:**
   - Create `src/utils/credential_manager.py`
   - Implement CredentialManager class with all methods

3. **Add CLI argument support:**
   - Add `--update-credentials` flag to main CLI
   - Add `--require-linkedin` flag for Epic 6

4. **Test credential flow:**
   - Delete .env file
   - Run application
   - Verify prompts appear
   - Verify credentials saved
   - Verify credentials loaded on subsequent run

5. **Test file permissions:**
   - Verify .env has 600 permissions on Unix systems
   - Test on Windows (permissions not enforced)

6. **Document in README:**
   - Add credential setup section
   - Document how to update credentials
   - Document security best practices

7. **Commit changes:**
   ```bash
   git add .env.example src/utils/credential_manager.py
   git commit -m "Add credential management with CLI prompts"
   ```

---

## Dependencies

**Prerequisites:**
- Story 1.1 (Core Dependency Installation) must be complete (requires python-dotenv, rich)

**Depends On:**
- Story 1.1: Core Dependency Installation

**Blocks:**
- Story 1.5: MCP Server Setup (may need credentials for LinkedIn MCP server)
- Epic 6 stories (require LinkedIn credentials)

---

## Testing

### Test File Location

`tests/unit/test_credential_manager.py`

### Test Cases

1. **Test credential loading from existing .env:**
   - Create .env with test credentials
   - Verify credentials loaded without prompting

2. **Test credential prompting for missing values:**
   - Delete .env
   - Mock user input
   - Verify prompt appears and credential saved

3. **Test credential masking:**
   - Verify mask_credential() masks correctly
   - Test with various string lengths

4. **Test file permissions (Unix only):**
   - Verify .env has 600 permissions after creation
   - Skip test on Windows

5. **Test update credentials flow:**
   - Mock user confirming updates
   - Verify new credentials saved

6. **Test required vs optional credentials:**
   - Test with require_linkedin=True
   - Test with require_linkedin=False
   - Verify optional credentials skipped

### Example Test

```python
def test_get_credential_prompts_when_missing(mocker, tmp_path):
    # Arrange
    env_file = tmp_path / ".env"
    cred_manager = CredentialManager(env_file=env_file)

    # Mock user input
    mocker.patch("rich.prompt.Prompt.ask", return_value="test@example.com")

    # Act
    result = cred_manager.get_credential(
        "TEST_CREDENTIAL",
        "Test credential",
        is_password=False,
        required=True
    )

    # Assert
    assert result == "test@example.com"
    assert env_file.exists()
    assert "TEST_CREDENTIAL=test@example.com" in env_file.read_text()
```

---

## Notes

- **MCP Server Credentials:** LinkedIn credentials also need to be configured in mcp-linkedin server settings (Story 1.5)
- **Security:** .env file contains sensitive data - never commit to git
- **File Permissions:** Only enforced on Unix systems (Linux, macOS)
- **Credential Updates:** Users can update via `--update-credentials` flag without editing .env manually
- **Password Masking:** All password inputs masked with `password=True` in Prompt.ask()
- **Logging:** Credentials must NEVER appear in logs - use mask_credential() for any logging

---

## References

- **PRD:** `docs/prd.md` - FR2 (Playwright authentication), FR3 (CLI prompts for credentials)
- **Architecture:** `docs/architecture.md` - Security section, Credential storage
