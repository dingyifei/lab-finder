# Story 2.3: Department Relevance Filtering

## Status

**Ready for Review**

## Story

**As a** user,
**I want** irrelevant departments filtered out before professor discovery,
**so that** the system doesn't waste time scraping departments with no relevant labs.

## Acceptance Criteria

1. LLM analyzes each department against user's consolidated research profile (FR9)
2. Departments with ANY potential research overlap are included
3. Obviously unrelated departments excluded (e.g., literature for bioengineering student)
4. Reasoning logged for each filtering decision (NFR17)
5. Filtered departments list saved for user review
6. Remaining departments list passed to next epic
7. Progress shows "Filtered X of Y departments"

## Tasks / Subtasks

- [x] **Task 1: Load User Research Profile** (AC: 1)
  - [x] Load consolidated profile from `output/user-profile.md` (from Story 1.7)
  - [x] Extract research interests section
  - [x] Extract degree program and background
  - [x] Pass profile to LLM filtering function

- [x] **Task 2: Implement LLM-Based Relevance Filtering** (AC: 1, 2, 3)
  - [x] Use `llm_helpers.py` prompt template for department filtering (Story 1.4)
  - [x] Prompt template:
    ```
    Given user research interests: {interests}
    Degree program: {degree}
    Background: {background}

    Is department "{department_name}" ({school}) relevant for this user's research?

    Guidelines:
    - Include if ANY potential research overlap exists
    - Include interdisciplinary departments
    - Exclude only obviously unrelated departments

    Respond with:
    - Decision: Yes/No
    - Confidence: 0-100
    - Reasoning: Brief explanation
    ```
  - [x] Call LLM for each department
  - [x] Parse LLM response (decision, confidence, reasoning)
  - [x] Apply decision to filter departments

- [x] **Task 3: Handle Edge Cases & Interdisciplinary Departments** (AC: 2)
  - [x] Ensure departments with partial overlap are INCLUDED
  - [x] Handle interdisciplinary departments (e.g., "Bioengineering & CS")
  - [x] Handle generic departments (e.g., "Graduate Studies") - include by default
  - [x] Handle ambiguous department names - favor inclusion over exclusion
  - [x] Log edge case decisions separately for user review

- [x] **Task 4: Update Department Models with Relevance Flags** (AC: 1, 6)
  - [x] Add `is_relevant: bool` field to Department model (from Story 2.1)
  - [x] Add `relevance_reasoning: str` field to Department model
  - [x] Set fields based on LLM filtering decision
  - [x] Preserve all departments (both relevant and filtered) in checkpoint

- [x] **Task 5: Log All Filtering Decisions** (AC: 4)
  - [x] Use structured logger from Story 1.4
  - [x] Bind correlation_id to logger context:
    ```python
    logger = get_logger(
        correlation_id=correlation_id,
        component="department_filter"
    )
    ```
  - [x] Log format (correlation_id automatically included):
    ```json
    {
      "correlation_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "component": "department_filter",
      "department_id": "dept-001",
      "department_name": "Computer Science",
      "school": "Engineering",
      "decision": "include",
      "confidence": 95,
      "reasoning": "Direct match with user's AI/ML interests"
    }
    ```
  - [x] Log all decisions at INFO level
  - [x] Log edge cases at WARNING level

- [x] **Task 6: Save Filtered Departments for User Review** (AC: 5)
  - [x] Create `output/filtered-departments.md` report
  - [x] List all EXCLUDED departments with reasoning
  - [x] Format as markdown table:
    | Department | School | Reason | Confidence |
  - [x] Include summary: "Filtered out X of Y departments"
  - [x] Provide instructions: "Review this list to ensure no relevant departments were excluded. If you find departments that should be included, you can manually adjust the checkpoint file `checkpoints/phase-1-relevant-departments.jsonl` or re-run with adjusted research interests."

- [x] **Task 7: Save Relevant Departments to Checkpoint** (AC: 6)
  - [x] Filter Department list to only `is_relevant == True`
  - [x] Save to `checkpoints/phase-1-relevant-departments.jsonl`
  - [x] Use checkpoint_manager.save_batch()
  - [x] This becomes input for Epic 3 professor discovery
  - [x] Log count: "X relevant departments identified for professor discovery"

- [x] **Task 8: Implement Progress Tracking** (AC: 7)
  - [x] Use progress_tracker from Story 1.4
  - [x] Batch size configured in `config/system_params.json` (departments batch_sizes setting)
  - [x] Display: "Phase 1: Department Filtering [X/Y departments processed]"
  - [x] Update progress after each department filtered
  - [x] Display final summary: "Filtered X of Y departments (Z% retained)"

## Dev Notes

### Relevant Architecture Information

**Component:** University Structure Discovery Agent - Department Filter Module (Epic 2)

**Responsibility:** Filter departments based on research relevance; preserve transparency (Epic 2: FR9)

**Key Interfaces:**
- `filter_departments(departments: list[Department], profile: UserProfile) -> list[Department]` - LLM-based relevance filtering

**Dependencies:**
- LLM Helpers for prompt templates and LLM calls (Story 1.4)
- Structured Logger for decision logging (Story 1.4)
- Progress Tracker for status updates (Story 1.4)
- Checkpoint Manager for saving results (Story 1.4)
- User profile from Story 1.7

**Technology Stack:**
- Claude LLM via llm_helpers
- structlog with component context
- Pydantic Department model with relevance fields

**Source Tree Location:**
- Modify: `src/agents/university_discovery.py` (add filter_departments method)
- Modify: `src/models/department.py` (add is_relevant and relevance_reasoning fields)
- Create: `output/filtered-departments.md` (user review report)
- Create: `checkpoints/phase-1-relevant-departments.jsonl` (filtered results)

**Updated Department Model:**
```python
class Department(BaseModel):
    id: str  # Unique identifier (generated)
    name: str  # Department name
    school: Optional[str] = None  # Parent school/college
    division: Optional[str] = None  # Parent division
    url: str  # Department homepage URL
    hierarchy_level: int  # Depth in organizational tree (0=school, 1=division, 2=department)
    is_relevant: bool = False  # Result of relevance filtering (set in Story 2.3)
                                # Default False until filtering completes
    relevance_reasoning: str = ""  # LLM explanation (set in Story 2.3)
                                    # Empty string default until filtering completes
```

**Note:** The `is_relevant` and `relevance_reasoning` fields are initialized with defaults (`False` and `""`) because departments are created in Story 2.1 before filtering occurs in this story. These defaults will be updated during the filtering process.

**LLM Prompt Template (from llm_helpers.py):**
```python
DEPARTMENT_RELEVANCE_PROMPT = """
Given user research interests: {interests}
Degree program: {degree}
Background: {background}

Is department "{department_name}" ({school}) relevant for this user's research?

Guidelines:
- Include if ANY potential research overlap exists
- Include interdisciplinary departments
- Exclude only obviously unrelated departments

Respond in JSON format:
{{
  "decision": "include" | "exclude",
  "confidence": 0-100,
  "reasoning": "brief explanation"
}}
"""
```

**Filtering Philosophy:**
- **Inclusive by default:** When in doubt, include the department
- **ANY overlap criterion:** Even tangential research connections should pass filter
- **Exclude only obvious mismatches:** E.g., literature department for bioengineering student
- **Preserve transparency:** All decisions logged and reviewable

**Critical Rules (from Coding Standards):**
- All LLM calls must use llm_helpers module
- Never use print() for logging (use structlog)
- Always type hint function signatures
- Use checkpoint_manager.save_batch() - never write JSONL directly
- **IMPORTANT:** All LLM calls, checkpoint operations, and I/O must use async/await patterns (async def, await keywords)

**Architecture Component Diagram Flow:**
```
CLI Coordinator → University Discovery Agent (filter_departments)
University Discovery Agent → LLM Helpers (department relevance prompt)
University Discovery Agent → Logger (log all decisions)
University Discovery Agent → Checkpoint Manager (save relevant departments)
University Discovery Agent → File System (save filtered-departments.md)
```

### Testing

**Test File Location:** `tests/unit/test_department_filter.py`

**Testing Standards:**
- Framework: pytest 8.4.2
- Mock LLM responses with pytest-mock
- Coverage requirement: 70% minimum
- Use pytest-asyncio for async test functions

**Test Requirements:**
1. Unit test for filter_departments function with mock LLM responses
2. Test inclusive filtering (ANY overlap includes department)
3. Test obvious exclusion (completely unrelated department)
4. Test edge cases (interdisciplinary, ambiguous names)
5. Test logging of all decisions
6. Test checkpoint saving of relevant departments
7. Test filtered-departments.md report generation

**Example Test Pattern:**
```python
def test_filter_departments_includes_partial_overlap(mocker):
    # Arrange
    mock_llm = mocker.patch('src.utils.llm_helpers.call_llm_with_retry')
    mock_llm.return_value = '{"decision": "include", "confidence": 75, "reasoning": "Partial overlap with data science"}'

    departments = [
        Department(id="1", name="Statistics", school="Science",
                   url="https://stats.edu", hierarchy_level=1)
    ]
    profile = UserProfile(research_interests="Machine Learning and AI")

    # Act
    relevant = filter_departments(departments, profile)

    # Assert
    assert len(relevant) == 1
    assert relevant[0].is_relevant == True
    assert relevant[0].relevance_reasoning == "Partial overlap with data science"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-07 | 0.2 | Applied validation improvements: Updated pytest version to 8.4.2, added async/await documentation, clarified correlation_id logging pattern, documented Department model field defaults, added system_params.json reference, improved user guidance for filtered departments | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - all tests passed without issues.

### Completion Notes List

- Successfully implemented department relevance filtering with LLM-based decision making
- Updated `DEPARTMENT_RELEVANCE_TEMPLATE` in llm_helpers.py to use JSON response format
- Updated `analyze_department_relevance()` function signature to accept degree and background parameters
- Added `load_user_profile()` method to UniversityDiscoveryAgent for parsing user profile markdown
- Added `filter_departments()` async method with progress tracking and edge case detection
- Implemented edge case detection for interdisciplinary, generic, and ambiguous departments
- Added `save_filtered_departments_report()` to generate user-facing markdown report of excluded departments
- Added `save_relevant_departments_checkpoint()` to save filtered results to JSONL checkpoint
- Created comprehensive test suite with 22 tests covering all functionality
- Fixed 2 existing llm_helpers tests that were broken by signature changes
- All 249 unit tests passing with 87% code coverage (exceeds 70% requirement)
- Code passes ruff linting and mypy type checking

### File List

**Modified:**
- `src/utils/llm_helpers.py` - Updated DEPARTMENT_RELEVANCE_TEMPLATE to JSON format, updated analyze_department_relevance() signature
- `src/agents/university_discovery.py` - Added load_user_profile(), filter_departments(), _is_edge_case(), _classify_edge_case(), save_filtered_departments_report(), save_relevant_departments_checkpoint()
- `tests/unit/test_llm_helpers.py` - Updated 2 existing tests to match new analyze_department_relevance() signature

**Created:**
- `tests/unit/test_department_filter.py` - Comprehensive test suite with 22 tests for Story 2.3 functionality

## QA Results

_To be populated by QA agent_
