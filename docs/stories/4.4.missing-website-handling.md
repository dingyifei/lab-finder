# Story 4.4: Graceful Handling of Missing/Stale Websites

## Status

**Draft**

## Story

**As a** user,
**I want** the system to handle missing or severely outdated websites gracefully,
**so that** these labs aren't excluded from analysis entirely.

## Acceptance Criteria

1. Missing websites detected and flagged (NFR13, FR31)
2. Stale websites (>2 years since update) identified
3. Data quality issues logged for these labs (FR32)
4. System continues processing using alternative data sources (publications)
5. Reports clearly indicate "website unavailable" or "last updated: [date]"
6. No website failures cause entire analysis to fail

## Tasks / Subtasks

- [ ] **Task 1: Detect Missing Websites** (AC: 1)
  - [ ] If lab_url is None: Flag "no_website"
  - [ ] If scraping returns 404: Flag "website_not_found"
  - [ ] Log all missing website cases

- [ ] **Task 2: Identify Stale Websites** (AC: 2)
  - [ ] Check Lab.last_updated or Lab.last_wayback_snapshot
  - [ ] If date >2 years ago: Flag "stale_website"
  - [ ] Calculate staleness score

- [ ] **Task 3: Continue Processing with Alternative Data** (AC: 4)
  - [ ] For labs with missing/stale websites:
    - Rely on publication data (Epic 5)
    - Infer lab members from co-authorship (Story 5.5)
  - [ ] Flag reliance on alternative sources
  - [ ] Don't skip these labs

- [ ] **Task 4: Add Website Status to Lab Model** (AC: 1, 2)
  - [ ] Add field: `website_status: str`
  - [ ] Values: "active", "stale", "missing", "unavailable"

- [ ] **Task 5: Create Missing Website Report** (AC: 3, 5)
  - [ ] Generate `output/missing-websites.md`
  - [ ] List all labs with website issues
  - [ ] Include alternative data sources being used

## Dev Notes

### Relevant Architecture Information

**Component:** Lab Research Agent - Missing Data Handler (Epic 4)

**Responsibility:** Gracefully handle missing/stale websites; enable alternative data collection (Epic 4: NFR13, FR31)

**Key Interfaces:**
- `determine_website_status(lab: Lab) -> str` - Classify website status
- `apply_alternative_data_strategy(lab: Lab) -> None` - Use publications when website unavailable

**Dependencies:**
- Lab website data from Story 4.1
- Archive.org data from Story 4.2
- Publication data pipeline (Epic 5) for alternative source

**Technology Stack:**
- Python datetime for staleness calculation
- structlog for missing data logging
- Pydantic Lab model with status fields

**Source Tree Location:**
- Modify: `src/agents/lab_research.py` (add status detection)
- Modify: `src/models/lab.py` (add website_status field)
- Create: `output/missing-websites.md` (user report)

**Updated Lab Model (with Status Field):**
```python
class Lab(BaseModel):
    id: str
    professor_id: str
    professor_name: str
    department: str
    lab_name: str
    lab_url: Optional[str] = None
    last_updated: Optional[datetime] = None
    description: str = ""
    research_focus: list[str] = []
    news_updates: list[str] = []
    website_content: str = ""
    data_quality_flags: list[str] = []
    last_wayback_snapshot: Optional[datetime] = None
    wayback_snapshots: list[datetime] = []
    update_frequency: str = "unknown"
    contact_emails: list[str] = []
    contact_form_url: Optional[str] = None
    application_url: Optional[str] = None
    # Website status (Story 4.4)
    website_status: str = "unknown"  # active/aging/stale/missing/unavailable
```

**Staleness Detection Logic:**
```python
from datetime import datetime

def determine_website_status(lab: Lab) -> str:
    """Determine website status based on update dates."""
    if not lab.lab_url:
        return "missing"

    # Prefer actual update date, fallback to Archive.org
    last_update = lab.last_updated or lab.last_wayback_snapshot

    if not last_update:
        return "unknown"

    age_days = (datetime.now() - last_update).days

    if age_days > 730:  # 2 years
        return "stale"
    elif age_days > 365:  # 1 year
        return "aging"
    else:
        return "active"
```

**Alternative Data Strategy:**
```python
def apply_alternative_data_strategy(lab: Lab) -> None:
    """Configure lab to use alternative data sources."""
    if lab.website_status in ["missing", "stale", "unavailable"]:
        # Flag for publication-based analysis (Epic 5)
        lab.data_quality_flags.append("using_publication_data")

        # Flag for member inference from co-authorship (Story 5.5)
        if not lab.members or len(lab.members) == 0:
            lab.data_quality_flags.append("members_will_be_inferred")

        logger.info(f"Lab {lab.lab_name}: Using alternative data sources",
                   website_status=lab.website_status,
                   alternative_sources=["publications", "co-authorship"])
```

**Missing Website Report Format:**
```markdown
# Labs with Missing or Stale Websites

## Summary
- Total labs analyzed: 150
- Labs with missing websites: 25 (16.7%)
- Labs with stale websites (>2 years): 15 (10%)
- Labs with aging websites (1-2 years): 20 (13.3%)

## Missing Websites

| Lab | Professor | Department | Alternative Data |
|-----|-----------|------------|------------------|
| AI Lab | Dr. Smith | CS | Publications, Co-authorship |

## Stale Websites (>2 years old)

| Lab | Professor | Last Updated | Alternative Data |
|-----|-----------|--------------|------------------|
| ML Lab | Dr. Doe | 2022-01-15 | Publications |

**Note:** These labs will rely on publication data and co-authorship inference for analysis.
```

**Critical Rules (from Coding Standards):**
- Never fail pipeline for missing websites
- Always provide alternative data strategy
- Flag all data quality issues transparently
- Never use print() for logging (use structlog)
- Continue processing with graceful degradation

**Architecture Component Diagram Flow:**
```
Lab Research Agent → Website Status Detector
  ↓
Missing/Stale Detection
  ↓ (if missing/stale)
Alternative Data Strategy
  ↓
Flag for Publication-Based Analysis (Epic 5)
  ↓
Flag for Member Inference (Story 5.5)
  ↓
Lab Model Update (status + flags)
  ↓
Missing Websites Report (output/missing-websites.md)
  ↓
Checkpoint Manager (save with flags)
```

### Testing

**Test File Location:** `tests/unit/test_missing_website_handling.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Test with various website states
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Test website status detection (missing/active/aging/stale/unknown)
2. Test staleness calculation with various dates
3. Test alternative data strategy application
4. Test data quality flag assignment
5. Test missing website report generation
6. Test graceful continuation (no failures)
7. Test integration with Epic 5 publication pipeline
8. Edge case: Lab with no URL and no publications

**Example Test Pattern:**
```python
def test_determine_website_status_stale():
    # Arrange
    lab = Lab(
        id="lab-1",
        professor_id="prof-1",
        lab_name="Old Lab",
        lab_url="https://old.edu",
        last_updated=datetime(2021, 1, 1)  # >2 years ago
    )

    # Act
    status = determine_website_status(lab)

    # Assert
    assert status == "stale"
    assert lab.data_quality_flags == []  # Not yet applied

def test_apply_alternative_data_strategy():
    # Arrange
    lab = Lab(
        id="lab-1",
        professor_id="prof-1",
        lab_name="Missing Website Lab",
        lab_url=None,
        website_status="missing"
    )

    # Act
    apply_alternative_data_strategy(lab)

    # Assert
    assert "using_publication_data" in lab.data_quality_flags
    assert "members_will_be_inferred" in lab.data_quality_flags
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
