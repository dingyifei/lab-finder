# Story 1.5: MCP Server Configuration & Testing

**Epic:** Epic 1 - Foundation & Configuration Infrastructure

**Status:** COMPLETE (Phase 4 implementation via .mcp.json)

---

## Story

**As a** developer/user,
**I want** MCP servers (paper-search-mcp, mcp-linkedin, and Puppeteer MCP) configured via `.mcp.json` file and validated before implementing publication retrieval, LinkedIn matching, and web scraping features,
**so that** Epics 3, 4, 5, and 6 can proceed without blocking on missing external dependencies.

## Acceptance Criteria

1. `claude/` SDK working directory created with proper structure
2. `claude/.mcp.json` file created with all 3 MCP servers configured (Puppeteer, papers, linkedin)
3. paper-search-mcp MCP server installed and accessible via subprocess STDIO
4. mcp-linkedin MCP server configured with LinkedIn credentials
5. Puppeteer MCP (@modelcontextprotocol/server-puppeteer) configured for browser automation
6. All MCP servers tested with connectivity validation script
7. `.mcp.json` configuration validated via ClaudeSDKClient test (replaces AC 7 v0.2: "MCP client wrapper utility")
8. MCP server configuration documented in project README
9. Error handling pattern defined for MCP server unavailability
10. Fallback behavior defined when MCP servers fail (skip with data quality flags)

## Tasks / Subtasks

- [ ] **Task 0: Create SDK Working Directory Structure** (AC: 1)
  - [ ] Create `claude/` directory at project root
  - [ ] Create `claude/.claude/` subdirectory for SDK settings
  - [ ] Create `claude/.claude/settings.json` (empty or minimal config)
  - [ ] Add `claude/` to .gitignore (exclude transient SDK state)
  - [ ] Document directory purpose in README

- [ ] **Task 1: Install paper-search-mcp MCP Server** (AC: 3)
  - [ ] Install via pip: `pip install paper-search-mcp`
  - [ ] Add to requirements.in: `paper-search-mcp>=0.1.3`
  - [ ] Verify installation: `python -m paper_search_mcp.server --help`
  - [ ] Document version installed in README

- [ ] **Task 2: Install Puppeteer MCP Server** (AC: 5)
  - [ ] Verify Node.js/npm installed: `npm --version`
  - [ ] Test npx can download Puppeteer MCP: `npx -y @modelcontextprotocol/server-puppeteer --help`
  - [ ] Document Puppeteer MCP version in README
  - [ ] Note: First run takes ~17 seconds for npx download, subsequent runs cached

- [ ] **Task 3: Verify mcp-linkedin MCP Server Setup** (AC: 4)
  - [ ] No pre-installation needed (runs via uvx on-demand)
  - [ ] LinkedIn credentials already documented in .env.example
  - [ ] Test uvx can run server: `uvx --from git+https://github.com/adhikasp/mcp-linkedin mcp-linkedin --help`
  - [ ] Document credential configuration in README
  - [ ] Note: Server spawned by Claude Agent SDK via STDIO, not installed globally

- [ ] **Task 4: Create .mcp.json Configuration File** (AC: 2, 7)
  - [ ] Create `claude/.mcp.json` with all 3 MCP servers
  - [ ] Configure Puppeteer MCP:
    ```json
    "puppeteer": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-puppeteer"]
    }
    ```
  - [ ] Configure paper-search-mcp:
    ```json
    "papers": {
      "type": "stdio",
      "command": "python",
      "args": ["-m", "paper_search_mcp.server"]
    }
    ```
  - [ ] Configure mcp-linkedin:
    ```json
    "linkedin": {
      "type": "stdio",
      "command": "uvx",
      "args": ["--from", "git+https://github.com/adhikasp/mcp-linkedin", "mcp-linkedin"],
      "env": {
        "LINKEDIN_EMAIL": "${LINKEDIN_EMAIL}",
        "LINKEDIN_PASSWORD": "${LINKEDIN_PASSWORD}"
      }
    }
    ```
  - [ ] Validate JSON syntax

- [ ] **Task 5: Create MCP Discovery Validation Script** (AC: 6, 7)
  - [ ] Create `experiments/validate_mcp_config.py` script
  - [ ] Test ClaudeSDKClient with `cwd="./claude"` discovers `.mcp.json`
  - [ ] Verify `setting_sources=["project"]` loads MCP servers
  - [ ] Verify `setting_sources=None` provides isolated context
  - [ ] Test each MCP server spawns successfully (capture spawn, not tool invocation)
  - [ ] Print validation results with clear success/failure messages
  - [ ] Script returns exit code 0 on success, 1 on failure

- [ ] **Task 6: Update Test Suite** (AC: 6)
  - [ ] **DELETE:** `tests/unit/test_mcp_client.py` (wrong MCP approach)
  - [ ] **DELETE or REPURPOSE:** `src/utils/mcp_client.py` (deprecated approach)
  - [ ] Create `tests/integration/test_mcp_discovery.py`:
    - Test `.mcp.json` discovery via `cwd` parameter
    - Test each MCP server config structure valid
    - Test ClaudeSDKClient can spawn each server
  - [ ] Integration tests marked with `@pytest.mark.integration`
  - [ ] Tests use subprocess to validate server spawning (not MCP protocol)

- [ ] **Task 7: Document MCP Server Setup** (AC: 8)
  - [ ] Update README with new `.mcp.json` approach
  - [ ] Document `claude/` directory structure and purpose
  - [ ] Provide complete `.mcp.json` example
  - [ ] Document LinkedIn credentials configuration in .env file
  - [ ] Provide troubleshooting steps for common MCP issues
  - [ ] Include code examples using `cwd` parameter pattern
  - [ ] Remove references to deprecated `mcp_client.py` approach

- [ ] **Task 8: Document Fallback Behavior** (AC: 9, 10)
  - [ ] Document fallback pattern in README
  - [ ] Pattern: catch exceptions, log warnings, add data quality flags, continue
  - [ ] Actual fallback implementation will be in Epic 3, 4, 5 & 6 stories
  - [ ] Provide code examples for graceful degradation
  - [ ] Reference: Phase 1 experiment results (`docs/experiments/web-scraping-mcp-validation.md`)

---

## Dependencies

**Prerequisites:**
- Story 1.1 (Core Dependency Installation) - requires Node.js/npm for Puppeteer MCP
- Story 1.3 (Credential Management) - LinkedIn credentials needed for mcp-linkedin configuration

**Depends On:**
- Story 1.1: Core Dependency Installation
- Story 1.3: Credential Management with CLI Prompts

**Blocks:**
- Epic 3: Professor Discovery (requires Puppeteer MCP for web scraping)
- Epic 4: Lab Intelligence (requires Puppeteer MCP for lab website scraping)
- Epic 5: Publication Retrieval (requires paper-search-mcp)
- Epic 6: LinkedIn Integration (requires mcp-linkedin)

---

## Dev Notes

### Relevant Architecture Information

**🚨 CRITICAL ARCHITECTURE CORRECTION (2025-10-09):**
Sprint Change Proposal identified fundamental misunderstanding of MCP integration approach. Story 1.5 requires MAJOR REWORK to replace Python-based MCP configuration (`mcp_client.py`) with `.mcp.json` file approach. See `SPRINT-CHANGE-PROPOSAL-2025-10-09-web-scraping-mcp-architecture.md` for full details.

**Phase 1 Pre-Flight Results:** All experiments validated (2025-10-09)
- ✅ SDK working directory with `.mcp.json` discovery: **WORKS**
- ✅ paper-search-mcp: **WORKS** (Epic 5 UNBLOCKED)
- ✅ Puppeteer MCP: **WORKS** (Epics 3 & 4 UNBLOCKED)
- ✅ mcp-linkedin: **LIKELY WORKS** (Python-based, same pattern as paper-search-mcp)
- ✅ Subprocess MCP architecture: **PROVEN FUNCTIONAL**

**Reference:** `docs/experiments/web-scraping-mcp-validation.md`

**MCP Servers Required:**
- `@modelcontextprotocol/server-puppeteer` (Node.js package) - Browser automation (Epics 3, 4)
- `paper-search-mcp` (Python package) - Publication retrieval (Epic 5)
- `mcp-linkedin` (Git-based, adhikasp) - LinkedIn profile access (Epic 6)

**Installation:**
- Puppeteer MCP: No pre-install - runs via `npx -y @modelcontextprotocol/server-puppeteer`
- paper-search-mcp: `pip install paper-search-mcp` (Python 3.11+)
- mcp-linkedin: No pre-install - runs via `uvx --from git+https://github.com/adhikasp/mcp-linkedin`

**Source Tree Location:**
- Create: `claude/.mcp.json` - MCP server configuration file
- Create: `claude/.claude/settings.json` - SDK settings (minimal or empty)
- Create: `experiments/validate_mcp_config.py` - Validation script
- DELETE: `src/utils/mcp_client.py` - Deprecated Python configuration approach
- DELETE: `tests/unit/test_mcp_client.py` - Tests deprecated approach

**Key Architecture Pattern: `.mcp.json` with `cwd` Parameter**

**Directory Structure:**
```
C:\Users\yifei\Documents\Research/
├── claude/                          # SDK working directory (isolated)
│   ├── .mcp.json                   # MCP server configuration
│   └── .claude/                    # SDK configuration directory
│       └── settings.json           # SDK settings
├── src/                            # Lab Finder application code
│   └── ...
```

**Why Isolated:**
- Keeps SDK configuration separate from Lab Finder codebase
- `.mcp.json` lives in `claude/`, not project root
- `.claude/` directory doesn't pollute project structure
- Clear separation: `claude/` = SDK, `src/` = application

**`.mcp.json` Format:**
```json
{
  "mcpServers": {
    "puppeteer": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-puppeteer"]
    },
    "papers": {
      "type": "stdio",
      "command": "python",
      "args": ["-m", "paper_search_mcp.server"]
    },
    "linkedin": {
      "type": "stdio",
      "command": "uvx",
      "args": ["--from", "git+https://github.com/adhikasp/mcp-linkedin", "mcp-linkedin"],
      "env": {
        "LINKEDIN_EMAIL": "${LINKEDIN_EMAIL}",
        "LINKEDIN_PASSWORD": "${LINKEDIN_PASSWORD}"
      }
    }
  }
}
```

**Usage Pattern in Application Code:**
```python
from claude_agent_sdk import ClaudeAgentOptions
from pathlib import Path

# For MCP-enabled operations (loads .mcp.json)
options_with_mcp = ClaudeAgentOptions(
    cwd=Path(__file__).parent.parent / "claude",  # Points to claude/ directory
    setting_sources=["project"],                   # Loads .mcp.json
    allowed_tools=["mcp__puppeteer__navigate", "mcp__puppeteer__evaluate"],
    system_prompt="You are a web scraping assistant..."
)

# For isolated operations (no MCP, no codebase context)
options_isolated = ClaudeAgentOptions(
    cwd=Path(__file__).parent.parent / "claude",
    setting_sources=None,                          # Isolated context
    allowed_tools=["WebFetch"],
    system_prompt="..."
)
```

**Key Architecture Decisions:**

**Claude Agent SDK MCP Integration:**
- MCP servers spawned as subprocesses via STDIO transport
- SDK auto-discovers `.mcp.json` in `cwd` directory
- `setting_sources=["project"]` loads `.mcp.json`
- `setting_sources=None` provides isolated context (no codebase injection)
- Application code accesses tools via `mcp__<server>__<tool>` pattern
- No manual connection/query functions needed

**Puppeteer MCP (@modelcontextprotocol/server-puppeteer):**
- Purpose: Browser automation for JavaScript-heavy university websites
- Documentation: https://github.com/modelcontextprotocol/servers/tree/main/src/puppeteer
- Authentication: None
- STDIO Command: `npx -y @modelcontextprotocol/server-puppeteer`
- MCP Tools: `mcp__puppeteer__navigate`, `mcp__puppeteer__evaluate`, `mcp__puppeteer__screenshot`, `mcp__puppeteer__click`, `mcp__puppeteer__fill`, `mcp__puppeteer__select`, `mcp__puppeteer__hover`
- Key Tool: `mcp__puppeteer__evaluate` - Executes arbitrary JavaScript in browser console
- First run: ~17 seconds (npx downloads package), subsequent runs cached
- Chrome-only (acceptable for university sites)

**paper-search-mcp:**
- Purpose: Retrieve academic publications for professors and lab members
- Documentation: https://github.com/openags/paper-search-mcp
- Authentication: None (optional SEMANTIC_SCHOLAR_API_KEY)
- STDIO Command: `python -m paper_search_mcp.server`
- MCP Tools: `mcp__papers__search_arxiv`, `mcp__papers__search_pubmed`, `mcp__papers__search_biorxiv`
- Query format: "author:Professor Name affiliation:University"

**mcp-linkedin:**
- Purpose: Match lab members to LinkedIn profiles
- Documentation: https://lobehub.com/mcp/adhikasp-mcp-linkedin
- Repository: https://github.com/adhikasp/mcp-linkedin
- Authentication: Environment variables (LINKEDIN_EMAIL, LINKEDIN_PASSWORD)
- STDIO Command: `uvx --from git+https://github.com/adhikasp/mcp-linkedin mcp-linkedin`
- MCP Tools: `mcp__linkedin__search_people`, `mcp__linkedin__get_profile`
- ⚠️ Uses unofficial LinkedIn API - use at your own risk

**Error Handling Pattern:**
- Retry/timeout handled by Claude Agent SDK (not application code)
- Fallback: Skip with data quality flag if MCP server unavailable
- MCP servers handle session management and rate limiting internally
- Graceful degradation: Missing tools don't block pipeline

**Critical Rules:**
- NEVER hardcode LinkedIn credentials in application code
- LinkedIn credentials passed via environment variables to MCP server
- MCP servers spawned by SDK - no manual spawning/connection code
- Application code uses MCP tools via ClaudeAgentOptions configuration
- Always use `cwd` parameter pointing to `claude/` directory

**Deprecated Approach (DO NOT USE):**
- ❌ `src/utils/mcp_client.py` - Python-based configuration (DELETE)
- ❌ `get_mcp_server_config()` function - Wrong pattern (DELETE)
- ❌ Programmatic MCP configuration via Python code (INCORRECT)

### Testing

**Test File Location:** `tests/integration/test_mcp_discovery.py`, `experiments/validate_mcp_config.py`

**Testing Standards (from Architecture):**
- **Framework:** pytest 7.4.4
- **Integration Tests:** Test `.mcp.json` discovery and MCP server spawning
- **DO NOT:** Test MCP protocol communication (Claude Agent SDK handles that)
- **DO:** Test subprocess spawning and configuration structure validation

**Test Requirements:**
1. **Integration Tests** (`tests/integration/test_mcp_discovery.py`):
   - Test ClaudeSDKClient with `cwd="./claude"` discovers `.mcp.json`
   - Test `setting_sources=["project"]` loads MCP servers
   - Test `setting_sources=None` provides isolated context
   - Test Puppeteer MCP can be spawned via npx
   - Test paper-search-mcp can be spawned: `python -m paper_search_mcp.server`
   - Test mcp-linkedin can be spawned via uvx (requires uvx installed)
   - Skip tests if servers not installed (mark with `@pytest.mark.skipif`)
   - Mark all tests with `@pytest.mark.integration`

2. **Validation Script** (`experiments/validate_mcp_config.py`):
   - Standalone script for manual validation
   - Test each MCP server config structure
   - Attempt to spawn each server (subprocess)
   - Print clear success/failure messages
   - Return exit code 0 on success, 1 on failure
   - Useful for troubleshooting MCP setup issues

3. **Fallback Behavior Tests**:
   - Test graceful handling when MCP servers unavailable
   - Verify data quality flags set correctly
   - Implementation in Epic 3, 4, 5, 6 stories

**Example Test Pattern:**
```python
# Integration Test
@pytest.mark.integration
def test_mcp_discovery_via_cwd():
    """Test that ClaudeSDKClient discovers .mcp.json in cwd directory."""
    # Arrange
    from pathlib import Path
    from claude_agent_sdk import ClaudeAgentOptions

    # Act
    options = ClaudeAgentOptions(
        cwd=Path(__file__).parent.parent.parent / "claude",
        setting_sources=["project"]
    )

    # Assert
    # If .mcp.json is malformed or missing, ClaudeAgentOptions will raise
    assert options.cwd.exists()
    assert (options.cwd / ".mcp.json").exists()

@pytest.mark.integration
def test_puppeteer_mcp_spawns():
    """Test that Puppeteer MCP can be spawned via npx."""
    # Arrange
    import subprocess

    # Act
    result = subprocess.run(
        ["npx", "-y", "@modelcontextprotocol/server-puppeteer", "--help"],
        capture_output=True,
        timeout=30  # First run may take ~17 seconds
    )

    # Assert
    assert result.returncode == 0, f"Puppeteer MCP failed to spawn: {result.stderr}"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-10-06 | 0.2 | Updated with correct MCP STDIO configuration based on architecture correction (Issue #2) | Bob (SM) |
| 2025-10-06 | 1.0 | Implementation complete - All tasks, tests, and documentation finished | James (Dev) |
| 2025-10-09 | 0.3 | **MAJOR REWORK:** Sprint Change Proposal identified wrong MCP integration approach. Rewrite to use `.mcp.json` with `cwd` parameter instead of `mcp_client.py`. Added Puppeteer MCP. AC 7 changed from "MCP client wrapper utility" to ".mcp.json configuration validated". All tasks rewritten. | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929 (v0.2 implementation)

### Completion Notes List (v0.2 - DEPRECATED)

**⚠️ DEPRECATED:** This implementation used wrong MCP integration approach (`mcp_client.py`). See v0.3 Change Log for rework details.

<details>
<summary>v0.2 Completion Notes (deprecated, click to expand)</summary>

- paper-search-mcp v0.1.3 installed successfully via pip and added to requirements.in
- mcp-linkedin verified working via uvx (no pre-installation required)
- Created `src/utils/mcp_client.py` with `get_mcp_server_config()` and `validate_mcp_config()` functions ❌ **WRONG APPROACH**
- Used `sys.executable` instead of hardcoded "python" to use current interpreter
- Implemented TypedDict for type safety on MCP server configuration structure
- Created comprehensive test suite: 11 unit tests + 9 integration tests (19 passing, 1 slow test marked) ❌ **TESTS DEPRECATED**
- Updated README with complete MCP server documentation including installation, configuration, and troubleshooting
- All code passes ruff linting and mypy strict type checking
- Fallback behavior pattern documented for Epic 5 & 6 implementation

</details>

### File List (v0.3 - REWORK REQUIRED)

**To CREATE:**
- `claude/.mcp.json` - MCP server configuration (Puppeteer, papers, linkedin)
- `claude/.claude/settings.json` - SDK settings (minimal or empty)
- `experiments/validate_mcp_config.py` - Validation script for `.mcp.json` discovery
- `tests/integration/test_mcp_discovery.py` - Integration tests for MCP discovery

**To DELETE:**
- `src/utils/mcp_client.py` - ❌ Deprecated Python configuration approach
- `tests/unit/test_mcp_client.py` - ❌ Tests deprecated approach

**To MODIFY:**
- `requirements.in` - Ensure paper-search-mcp>=0.1.3 present
- `requirements.txt` - Update via pip-compile
- `README.md` - Rewrite MCP Server Configuration section with `.mcp.json` approach
- `.gitignore` - Add `claude/` directory (exclude transient SDK state)

## QA Results

### Review Date: 2025-10-06 (v0.2 - DEPRECATED)

**⚠️ QA RESULTS OUTDATED:** These results apply to v0.2 implementation (deprecated `mcp_client.py` approach). Story requires QA re-assessment after v0.3 rework complete.

### Reviewed By: Quinn (Test Architect) (v0.2)

<details>
<summary>v0.2 QA Results (deprecated, click to expand)</summary>

### Code Quality Assessment (v0.2)

Excellent implementation with strong fundamentals. The MCP server configuration helper demonstrates professional code quality with comprehensive documentation, type safety via TypedDict, and portable design using `sys.executable`. The separation of concerns (config generation vs validation) is well-architected, and the code passes both ruff linting and mypy type checking without issues.

**Key Strengths:**
- Comprehensive docstrings with usage examples and fallback pattern documentation
- Type-safe configuration structure with TypedDict
- Environment-portable design (sys.executable, python-dotenv)
- Excellent test coverage (20 tests: 11 unit + 9 integration)
- Clear separation: `get_mcp_server_config()` vs `validate_mcp_config()`

**Areas of Concern:**
- Silent credential failures: Empty strings returned when credentials missing (mcp_client.py:77-78) without warning
- Error handling appropriately deferred to Epic 5 & 6 but only documented (not implemented)
- validate_mcp_config() exists but not automatically called

### Gate Status (v0.2)

Gate: **CONCERNS** → docs/qa/gates/1.5-mcp-server-setup.yml

**Quality Score:** 80/100

### Recommended Status (v0.2)

✓ **Ready for Done** (v0.2 only - now DEPRECATED)

</details>

### QA Re-Assessment Required (v0.3)

**Status:** ⏳ **PENDING REWORK**

After v0.3 implementation complete, QA must re-assess:
- [ ] `.mcp.json` configuration correctness
- [ ] ClaudeSDKClient `cwd` parameter integration
- [ ] MCP server spawning validation
- [ ] Puppeteer MCP integration
- [ ] Updated test suite (integration tests)
- [ ] README accuracy for `.mcp.json` approach
- [ ] Deprecated code removed (`mcp_client.py`, tests)

**Target QA Score:** 95+/100 (correct architecture, comprehensive validation)

---

## References

- **PRD:** `docs/prd.md` - Epic 1, Story 1.5
- **Architecture:** `docs/architecture.md` - External APIs section (MCP servers)
- **Sprint Change Proposal:** `SPRINT-CHANGE-PROPOSAL-2025-10-09-web-scraping-mcp-architecture.md`
- **Phase 1 Experiments:** `docs/experiments/web-scraping-mcp-validation.md`
- **Puppeteer MCP:** https://github.com/modelcontextprotocol/servers/tree/main/src/puppeteer
- **MCP LinkedIn:** https://lobehub.com/mcp/adhikasp-mcp-linkedin
- **paper-search-mcp:** https://github.com/openags/paper-search-mcp
