# Story 1.5: MCP Server Configuration & Testing

## Status

**Draft**

## Story

**As a** developer/user,
**I want** MCP servers (paper-search-mcp and mcp-linkedin) installed, configured, and validated before implementing publication retrieval and LinkedIn matching features,
**so that** Epic 5 and Epic 6 can proceed without blocking on missing external dependencies.

## Acceptance Criteria

1. paper-search-mcp MCP server installed and accessible
2. mcp-linkedin MCP server installed with LinkedIn credentials configured
3. Both MCP servers tested with basic connectivity checks
4. MCP server configuration documented in project README
5. Error handling implemented for MCP server unavailability
6. Fallback behavior defined when MCP servers fail (skip with data quality flags)
7. MCP client wrapper utility (`src/utils/mcp_client.py`) created for consistent server interaction

## Tasks / Subtasks

- [ ] **Task 1: Install paper-search-mcp MCP Server** (AC: 1)
  - [ ] Install via npm: `npm install -g @modelcontextprotocol/server-paper-search`
  - [ ] Verify installation with test query
  - [ ] Document version installed in README

- [ ] **Task 2: Install mcp-linkedin MCP Server** (AC: 2)
  - [ ] Install via npm: `npm install -g mcp-linkedin`
  - [ ] Configure LinkedIn credentials in MCP server settings (NOT in application code)
  - [ ] Verify installation with test LinkedIn search
  - [ ] Document credential configuration process in README

- [ ] **Task 3: Create MCP Client Wrapper Utility** (AC: 7)
  - [ ] Create `src/utils/mcp_client.py` module
  - [ ] Implement `connect_to_mcp(server_name: str)` function
  - [ ] Implement `query_paper_search(author: str, affiliation: str, years: int)` function
  - [ ] Implement `search_linkedin_profile(name: str, university: str)` function
  - [ ] Add retry logic with exponential backoff (tenacity library)
  - [ ] Add timeout handling (60s for paper-search, 30s for linkedin)

- [ ] **Task 4: Implement Connectivity Testing** (AC: 3)
  - [ ] Create test script to validate paper-search-mcp connectivity
  - [ ] Create test script to validate mcp-linkedin connectivity
  - [ ] Add connectivity checks to project initialization (optional pre-flight check)
  - [ ] Log successful/failed connections with structured logging

- [ ] **Task 5: Document MCP Server Setup** (AC: 4)
  - [ ] Add MCP server installation section to README
  - [ ] Document required credentials and where to configure them
  - [ ] Provide troubleshooting steps for common MCP issues
  - [ ] Include example MCP server configurations

- [ ] **Task 6: Implement Fallback Behavior** (AC: 5, 6)
  - [ ] Catch MCP connection failures gracefully
  - [ ] Log failures with clear error messages
  - [ ] Continue pipeline execution with data quality flags
  - [ ] Example: "⚠️ LinkedIn matching skipped (mcp-linkedin unavailable)"

## Dev Notes

### Relevant Architecture Information

**MCP Servers Required:**
- `paper-search-mcp` - Publication retrieval (used in Epic 5)
- `mcp-linkedin` (adhikasp-mcp-linkedin) - LinkedIn profile access (used in Epic 6)

**Source Tree Location:**
- Create: `src/utils/mcp_client.py` - MCP server client wrapper
- Utility will be used by:
  - `src/agents/publication_retrieval.py` (Epic 5)
  - `src/agents/linkedin_matcher.py` (Epic 6)

**Key Architecture Decisions:**

From **External APIs** section:

**paper-search-mcp:**
- Purpose: Retrieve academic publications for professors and lab members
- Authentication: None (local MCP server)
- Rate Limits: Dependent on underlying search API (Semantic Scholar, arXiv)
- Key Tool: `search_papers(query: str, year_range: tuple, max_results: int)`
- Query format: "author:Professor Name affiliation:University"

**mcp-linkedin:**
- Purpose: Match lab members to LinkedIn profiles
- Documentation: https://lobehub.com/mcp/adhikasp-mcp-linkedin
- Repository: https://github.com/adhikasp/mcp-linkedin
- Authentication: LinkedIn credentials via MCP server configuration (NOT in application)
- Rate Limits: Managed internally by MCP server
- Key Tools:
  - `search_people(query: str, filters: dict)` - Search LinkedIn profiles
  - `get_profile(profile_url: str)` - Retrieve profile details

**Error Handling Pattern (from Architecture):**
- Retry Policy: Exponential backoff with jitter (tenacity library)
  - Max retries: 3
  - Initial delay: 1 second
  - Backoff multiplier: 2x
  - Max delay: 10 seconds
- Timeout Configuration:
  - MCP queries: 60 seconds per query
- Fallback: Skip with data quality flag if MCP unavailable

**Critical Rules:**
- NEVER hardcode LinkedIn credentials in application code
- LinkedIn credentials managed by mcp-linkedin server configuration
- MCP servers handle session management and renewal
- Application code only calls MCP tools (no credential handling)

### Testing

**Test File Location:** `tests/integration/test_mcp_client.py`

**Testing Standards (from Architecture):**
- **Framework:** pytest 7.4.4
- **Integration Tests:** Test interactions with MCP servers
- **Mock MCP Responses:** For unit tests, mock MCP server responses (no real LinkedIn access in automated tests)
- **Test Infrastructure:**
  - Run local paper-search-mcp server for tests
  - Mock mcp-linkedin server responses (avoid real LinkedIn API calls)
  - Use temporary directories via pytest fixtures

**Test Requirements:**
1. Unit tests for `mcp_client.py` wrapper functions (mock MCP responses)
2. Integration tests with actual paper-search-mcp (requires server running)
3. Integration tests with mocked mcp-linkedin (avoid real credentials)
4. Test retry logic on connection failures
5. Test timeout handling
6. Test fallback behavior when servers unavailable

**Example Test Pattern:**
```python
@pytest.mark.integration
async def test_paper_search_mcp_connection():
    # Arrange: Assume paper-search-mcp running on localhost
    client = MCPClient(server_url="localhost:3000")

    # Act
    result = await client.query_paper_search("Jane Smith", "Stanford", years=3)

    # Assert
    assert result is not None
    assert len(result) > 0
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
