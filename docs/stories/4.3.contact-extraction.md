# Story 4.3: Contact Information Extraction

## Status

**Draft**

## Story

**As a** user,
**I want** professor and lab contact information extracted,
**so that** I can easily reach out to prioritized labs.

## Acceptance Criteria

1. Email addresses extracted from lab websites and directory pages (FR20)
2. Contact form URLs identified
3. Application/prospective student URLs found if available
4. Contact information validated (basic email format check)
5. Multiple contact methods saved (direct email, lab email, contact form)
6. Missing contact info flagged but doesn't block processing

## Tasks / Subtasks

- [ ] **Task 1: Extract Email Addresses** (AC: 1, 4)
  - [ ] Search for email patterns in page content
  - [ ] Regex: `[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}`
  - [ ] Validate email format
  - [ ] Filter out generic emails (webmaster@, info@)
  - [ ] Prioritize professor-specific emails
  - [ ] Store in Lab.contact_emails: list[str]

- [ ] **Task 2: Identify Contact Form URLs** (AC: 2, 5)
  - [ ] Search for contact form links
  - [ ] Look for: "contact", "get in touch", "reach out"
  - [ ] Extract form URLs
  - [ ] Store in Lab.contact_form_url: Optional[str]

- [ ] **Task 3: Find Application/Prospective Student URLs** (AC: 3, 5)
  - [ ] Search for prospective student information
  - [ ] Keywords: "prospective", "apply", "join", "positions", "openings"
  - [ ] Extract application URLs
  - [ ] Store in Lab.application_url: Optional[str]

- [ ] **Task 4: Update Lab Model with Contact Fields** (AC: 5)
  - [ ] Add to Lab model:
    ```python
    contact_emails: list[str] = []  # Professor/lab emails
    contact_form_url: Optional[str] = None
    application_url: Optional[str] = None
    ```

- [ ] **Task 5: Handle Missing Contact Info** (AC: 6)
  - [ ] If no contact info found: Flag "no_contact_info"
  - [ ] Continue processing
  - [ ] Log: "No contact info for {lab_name}"

## Dev Notes

### Relevant Architecture Information

**Component:** Lab Research Agent - Contact Extraction Module (Epic 4)

**Responsibility:** Extract contact information from lab websites and professor profiles (Epic 4: FR20)

**Key Interfaces:**
- `extract_contact_info(website_content: str, profile_content: str) -> dict` - Extract all contact methods
- `validate_email(email: str) -> bool` - Validate email format

**Dependencies:**
- Lab website content from Story 4.1
- Professor profile data from Epic 3
- Python regex for email extraction

**Technology Stack:**
- Python re module for email pattern matching
- Python validators library for URL validation
- structlog for contact extraction logging

**Source Tree Location:**
- Modify: `src/agents/lab_research.py` (add contact extraction)
- Modify: `src/models/lab.py` (add contact fields)

**Updated Lab Model (with Contact Fields):**
```python
class Lab(BaseModel):
    id: str
    professor_id: str
    professor_name: str
    department: str
    lab_name: str
    lab_url: Optional[str] = None
    last_updated: Optional[datetime] = None
    description: str = ""
    research_focus: list[str] = []
    news_updates: list[str] = []
    website_content: str = ""
    data_quality_flags: list[str] = []
    last_wayback_snapshot: Optional[datetime] = None
    wayback_snapshots: list[datetime] = []
    update_frequency: str = "unknown"
    # Contact fields (Story 4.3)
    contact_emails: list[str] = []  # Professor/lab emails
    contact_form_url: Optional[str] = None
    application_url: Optional[str] = None
```

**Email Extraction Pattern:**
```python
import re

def extract_emails(text: str) -> list[str]:
    pattern = r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
    emails = re.findall(pattern, text)
    # Filter generic emails
    filtered = [e for e in emails if not e.startswith(('webmaster@', 'info@', 'admin@'))]
    return list(set(filtered))  # Remove duplicates

def validate_email(email: str) -> bool:
    """Basic email format validation"""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return bool(re.match(pattern, email))
```

**Contact Form URL Patterns:**
```python
CONTACT_PATTERNS = [
    r'href=["\']([^"\']*contact[^"\']*)["\']',
    r'href=["\']([^"\']*get-in-touch[^"\']*)["\']',
    r'href=["\']([^"\']*reach-out[^"\']*)["\']',
    r'href=["\']([^"\']*join[^"\']*)["\']'
]

def extract_contact_form(html: str) -> Optional[str]:
    for pattern in CONTACT_PATTERNS:
        match = re.search(pattern, html, re.IGNORECASE)
        if match:
            return match.group(1)
    return None
```

**Application URL Patterns:**
```python
APPLICATION_KEYWORDS = [
    'prospective', 'apply', 'join', 'positions',
    'openings', 'opportunities', 'PhD application'
]

def extract_application_url(html: str, base_url: str) -> Optional[str]:
    for keyword in APPLICATION_KEYWORDS:
        pattern = f'href=["\']([^"\']*{keyword}[^"\']*)["\']'
        match = re.search(pattern, html, re.IGNORECASE)
        if match:
            url = match.group(1)
            # Convert relative to absolute URL if needed
            if not url.startswith('http'):
                url = urljoin(base_url, url)
            return url
    return None
```

**Critical Rules (from Coding Standards):**
- Validate all extracted emails
- Filter out generic/system emails
- Never use print() for logging (use structlog)
- Always type hint function signatures
- Handle missing contact info gracefully (don't fail)

**Architecture Component Diagram Flow:**
```
Lab Research Agent → Website Content (from Story 4.1)
  ↓
Email Extraction (regex patterns)
  ↓
Email Validation & Filtering
  ↓
Contact Form URL Extraction
  ↓
Application URL Extraction
  ↓
Lab Model Update (contact fields)
  ↓
Checkpoint Manager (save updated lab data)
```

### Testing

**Test File Location:** `tests/unit/test_contact_extraction.py`

**Testing Standards:**
- Framework: pytest 7.4.4
- Test with mock HTML content
- Coverage requirement: 70% minimum

**Test Requirements:**
1. Test email extraction from HTML content
2. Test email validation (valid and invalid formats)
3. Test generic email filtering (webmaster@, info@, admin@)
4. Test contact form URL extraction
5. Test application URL extraction
6. Test missing contact info handling (graceful degradation)
7. Test relative to absolute URL conversion
8. Integration test with full lab website HTML

**Example Test Pattern:**
```python
def test_extract_emails_filters_generic():
    # Arrange
    html_content = """
    Contact: professor@university.edu
    Email: webmaster@university.edu
    Support: admin@university.edu
    Lab: lab-contact@university.edu
    """

    # Act
    emails = extract_emails(html_content)

    # Assert
    assert 'professor@university.edu' in emails
    assert 'lab-contact@university.edu' in emails
    assert 'webmaster@university.edu' not in emails
    assert 'admin@university.edu' not in emails
    assert len(emails) == 2
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story creation | Sarah (PO) |
