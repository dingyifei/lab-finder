# Story 1.7: User Profile Consolidation

**Epic:** Epic 1 - Foundation & Configuration Infrastructure

**Status:** Ready for Review

---

## User Story

As a **user**,
I want **my resume, degree program, university details, and research interests combined into a single coherent research profile document**,
so that **the system has a clear baseline for matching me with relevant labs**.

---

## Acceptance Criteria

1. System reads multiple JSON config sources (resume highlights, degree info, research interests, university details) (FR4)
2. Resume content parsed and key highlights extracted (education, skills, research experience)
3. Research interest statements streamlined and clarified using LLM
4. Consolidated profile document generated in markdown format (FR6)
5. Profile includes: background, current degree program, target university, research interests, key qualifications
6. Profile saved to output directory for user review (`output/user_profile.md`)
7. Profile used as input for all subsequent filtering and matching operations
8. Profile consolidator module created in `src/agents/profile_consolidator.py`

---

## Technical Details

### Input Sources

1. **User Profile Config** (`config/user_profile.json`):
   - Validated by Story 1.2
   - Contains: name, current_degree, target_university, target_department, research_interests, resume_highlights, preferred_graduation_duration

2. **University Config** (`config/university_config.json`):
   - Validated by Story 1.2
   - Contains: university_name, core_website, directory_link

### Profile Consolidator Agent

Create `src/agents/profile_consolidator.py`:

```python
"""
Profile Consolidator Agent
Combines user profile and university config into consolidated research profile document.
"""

from pathlib import Path
from typing import Dict, Any, List
from datetime import datetime

from pydantic import BaseModel
from src.utils.logger import get_logger
from src.utils.llm_helpers import call_llm_with_retry

logger = get_logger(correlation_id="profile-consolidation", phase="phase-0", component="profile_consolidator")

class ConsolidatedProfile(BaseModel):
    """Consolidated user research profile."""

    name: str
    current_degree: str
    target_university: str
    target_department: str
    research_interests: List[str]
    streamlined_interests: str  # LLM-generated concise summary
    education_background: str
    skills_summary: str
    research_experience_summary: str
    key_qualifications: List[str]
    preferred_graduation_duration: float
    university_website: str
    generated_at: str

class ProfileConsolidator:
    """Consolidates user profile into research baseline document."""

    def __init__(self, output_dir: Path = Path("output")):
        """
        Initialize profile consolidator.

        Args:
            output_dir: Directory to save consolidated profile
        """
        self.output_dir = output_dir
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def consolidate(
        self,
        user_profile: Dict[str, Any],
        university_config: Dict[str, Any]
    ) -> ConsolidatedProfile:
        """
        Consolidate user profile and university config into baseline document.

        Args:
            user_profile: Validated user profile configuration
            university_config: Validated university configuration

        Returns:
            ConsolidatedProfile with all extracted and processed information
        """
        logger.info("Starting profile consolidation")

        # Extract basic information
        profile = ConsolidatedProfile(
            name=user_profile["name"],
            current_degree=user_profile["current_degree"],
            target_university=user_profile["target_university"],
            target_department=user_profile["target_department"],
            research_interests=user_profile["research_interests"],
            streamlined_interests=self._streamline_interests(user_profile["research_interests"]),
            education_background=self._extract_education(user_profile.get("resume_highlights", {})),
            skills_summary=self._extract_skills(user_profile.get("resume_highlights", {})),
            research_experience_summary=self._extract_research_experience(user_profile.get("resume_highlights", {})),
            key_qualifications=self._extract_qualifications(user_profile),
            preferred_graduation_duration=user_profile.get("preferred_graduation_duration", 5.5),
            university_website=university_config["core_website"],
            generated_at=datetime.utcnow().isoformat()
        )

        logger.info("Profile consolidation complete", extra={
            "research_areas_count": len(profile.research_interests),
            "qualifications_count": len(profile.key_qualifications)
        })

        return profile

    def _streamline_interests(self, interests: List[str]) -> str:
        """
        Use LLM to streamline and clarify research interests.

        Args:
            interests: List of research interest statements

        Returns:
            Concise, coherent research interest summary
        """
        logger.debug("Streamlining research interests with LLM")

        prompt = f"""Given the following research interests, create a concise 2-3 sentence summary that captures the core research focus and expertise areas.

Research Interests:
{chr(10).join(f"- {interest}" for interest in interests)}

Provide a clear, professional summary suitable for matching with lab research areas."""

        streamlined = call_llm_with_retry(prompt)
        logger.debug("Research interests streamlined", extra={"length": len(streamlined)})

        return streamlined.strip()

    def _extract_education(self, resume_highlights: Dict[str, Any]) -> str:
        """
        Extract education background summary.

        Args:
            resume_highlights: Resume highlights section

        Returns:
            Education background summary string
        """
        education = resume_highlights.get("education", [])
        if not education:
            return "Education details not provided"

        # Format education entries
        entries = []
        for edu in education:
            degree = edu.get("degree", "Unknown Degree")
            institution = edu.get("institution", "Unknown Institution")
            year = edu.get("year", "")
            year_str = f" ({year})" if year else ""
            entries.append(f"{degree}, {institution}{year_str}")

        return "; ".join(entries)

    def _extract_skills(self, resume_highlights: Dict[str, Any]) -> str:
        """
        Extract skills summary.

        Args:
            resume_highlights: Resume highlights section

        Returns:
            Skills summary string
        """
        skills = resume_highlights.get("skills", [])
        if not skills:
            return "Skills not provided"

        return ", ".join(skills)

    def _extract_research_experience(self, resume_highlights: Dict[str, Any]) -> str:
        """
        Extract research experience summary.

        Args:
            resume_highlights: Resume highlights section

        Returns:
            Research experience summary string
        """
        experience = resume_highlights.get("research_experience", [])
        if not experience:
            return "Research experience not provided"

        # Format experience entries
        entries = []
        for exp in experience:
            title = exp.get("title", "Research Position")
            description = exp.get("description", "")
            duration = exp.get("duration", "")
            duration_str = f" ({duration})" if duration else ""
            entries.append(f"{title}{duration_str}: {description}")

        return "; ".join(entries)

    def _extract_qualifications(self, user_profile: Dict[str, Any]) -> List[str]:
        """
        Extract key qualifications from profile.

        Args:
            user_profile: User profile configuration

        Returns:
            List of key qualification statements
        """
        qualifications = []

        # Current degree
        qualifications.append(f"Currently pursuing {user_profile['current_degree']}")

        # Research interests count
        interests_count = len(user_profile["research_interests"])
        qualifications.append(f"{interests_count} primary research interest area(s)")

        # Skills count (if available)
        resume = user_profile.get("resume_highlights", {})
        skills = resume.get("skills", [])
        if skills:
            qualifications.append(f"{len(skills)} technical skills")

        # Research experience (if available)
        experience = resume.get("research_experience", [])
        if experience:
            qualifications.append(f"{len(experience)} research experience(s)")

        return qualifications

    def save_markdown(self, profile: ConsolidatedProfile) -> Path:
        """
        Save consolidated profile as markdown document.

        Args:
            profile: Consolidated profile to save

        Returns:
            Path to saved markdown file
        """
        output_path = self.output_dir / "user_profile.md"

        markdown_content = f"""# Research Profile: {profile.name}

**Generated:** {profile.generated_at}

---

## Overview

**Current Position:** {profile.current_degree}

**Target University:** {profile.target_university}

**Target Department:** {profile.target_department}

**University Website:** {profile.university_website}

---

## Research Interests

{chr(10).join(f"- {interest}" for interest in profile.research_interests)}

### Streamlined Research Focus

{profile.streamlined_interests}

---

## Academic Background

### Education

{profile.education_background}

### Skills

{profile.skills_summary}

### Research Experience

{profile.research_experience_summary}

---

## Key Qualifications

{chr(10).join(f"- {qual}" for qual in profile.key_qualifications)}

---

## Configuration

**Preferred PhD Graduation Duration:** {profile.preferred_graduation_duration} years

This value is used to estimate graduating PhD students when analyzing labs.

---

## Usage

This consolidated profile serves as the baseline for:

- **Department Filtering** (Epic 2): Identifies relevant departments at {profile.target_university}
- **Professor Filtering** (Epic 3): Matches professors based on research field alignment
- **Fitness Scoring** (Epic 7): Calculates lab-to-profile fit scores
- **Report Generation** (Epic 8): Personalizes lab recommendations

All filtering and matching decisions reference this profile to ensure consistency across the analysis pipeline.

---

*This document was automatically generated by the Lab Finder Profile Consolidator.*
"""

        output_path.write_text(markdown_content, encoding="utf-8")

        logger.info(
            "Consolidated profile saved",
            extra={"output_path": str(output_path)}
        )

        return output_path
```

### Checkpoint Integration

Save profile to checkpoint for resumability:

```python
# In profile consolidator

def save_checkpoint(self, profile: ConsolidatedProfile) -> None:
    """Save profile to checkpoint for resumability."""
    import json
    checkpoint_path = Path("checkpoints/phase-0-validation.json")
    checkpoint_path.parent.mkdir(parents=True, exist_ok=True)

    checkpoint_data = profile.model_dump()
    checkpoint_path.write_text(
        json.dumps(checkpoint_data, indent=2),
        encoding="utf-8"
    )

    logger.info("Profile checkpoint saved", extra={"checkpoint": str(checkpoint_path)})
```

### CLI Integration

Update CLI coordinator to call profile consolidator:

```python
# In main CLI or Phase 0 coordinator

from src.agents.profile_consolidator import ProfileConsolidator
from src.utils.validator import ConfigValidator

def run_phase_0_validation(config_dir: Path = Path("config")):
    """Run Phase 0: Validation & Setup."""

    # Validate configurations (Story 1.2)
    validator = ConfigValidator()
    configs = validator.validate_all_configs(
        user_profile_path=config_dir / "user_profile.json",
        university_config_path=config_dir / "university_config.json",
        system_params_path=config_dir / "system_params.json"
    )

    # Consolidate profile (Story 1.4)
    consolidator = ProfileConsolidator()
    profile = consolidator.consolidate(
        user_profile=configs["user_profile"],
        university_config=configs["university"]
    )

    # Save outputs
    markdown_path = consolidator.save_markdown(profile)
    consolidator.save_checkpoint(profile)

    console.print(f"[green]✅ Phase 0 complete: Profile saved to {markdown_path}[/green]")

    return profile
```

### Example Output

`output/user_profile.md`:

```markdown
# Research Profile: Jane Doe

**Generated:** 2024-10-06T15:30:00

---

## Overview

**Current Position:** PhD in Computer Science

**Target University:** Stanford University

**Target Department:** Computer Science

**University Website:** https://www.stanford.edu

---

## Research Interests

- Machine Learning
- Natural Language Processing
- Artificial Intelligence

### Streamlined Research Focus

Jane Doe's research focuses on advancing machine learning and natural language processing techniques with applications in artificial intelligence. Her expertise spans deep learning architectures, transformer models, and neural approaches to language understanding.

---

## Academic Background

### Education

MS in Computer Science, University of California, Berkeley (2022)

### Skills

Python, TensorFlow, PyTorch, Research Writing

### Research Experience

Research Assistant - NLP Lab (2021-2022): Developed transformer models for question answering

---

## Key Qualifications

- Currently pursuing PhD in Computer Science
- 3 primary research interest area(s)
- 4 technical skills
- 1 research experience(s)

---

## Configuration

**Preferred PhD Graduation Duration:** 5.5 years

This value is used to estimate graduating PhD students when analyzing labs.

---

## Usage

This consolidated profile serves as the baseline for:

- **Department Filtering** (Epic 2): Identifies relevant departments at Stanford University
- **Professor Filtering** (Epic 3): Matches professors based on research field alignment
- **Fitness Scoring** (Epic 7): Calculates lab-to-profile fit scores
- **Report Generation** (Epic 8): Personalizes lab recommendations

All filtering and matching decisions reference this profile to ensure consistency across the analysis pipeline.
```

---

## Implementation Steps

1. **Create profile consolidator agent:**
   - Create `src/agents/profile_consolidator.py`
   - Implement ProfileConsolidator class with all methods

2. **Create ConsolidatedProfile Pydantic model:**
   - Add to `src/models/profile.py` (or create if doesn't exist)

3. **Integrate with LLM helpers:**
   - Use `call_llm_with_retry()` from Story 1.4 for interest streamlining
   - Implement retry logic for LLM failures

4. **Create Phase 0 coordinator:**
   - Integrate validator (Story 1.2) and consolidator
   - Save checkpoint and markdown outputs

5. **Test profile consolidation:**
   - Use example user_profile.json
   - Verify markdown generation
   - Verify checkpoint saved
   - Verify LLM streamlining works

6. **Update README:**
   - Document user_profile.md output
   - Explain how profile is used in pipeline

7. **Commit changes:**
   ```bash
   git add src/agents/profile_consolidator.py src/models/profile.py
   git commit -m "Add user profile consolidation with LLM streamlining"
   ```

---

## Dependencies

**Prerequisites:**
- Story 1.1 (Core Dependencies) - requires pydantic, jsonschema
- Story 1.2 (JSON Schema Validation) - requires validated configs
- **Story 1.4 (Shared Utilities) - MUST be completed first** - requires llm_helpers, logger, checkpoint_manager

**Depends On:**
- Story 1.1: Core Dependency Installation
- Story 1.2: JSON Configuration Schema & Validation
- **Story 1.4: Shared Utilities Implementation (CRITICAL DEPENDENCY - implement 1.4 before 1.7)**

**Blocks:**
- Epic 2: University Structure Discovery (requires profile for department filtering)
- Epic 3: Professor Discovery (requires profile for professor matching)
- Epic 7: Fitness Scoring (requires profile for scoring)

**Implementation Note:**
- ⚠️ **Story 1.4 must be implemented before Story 1.7** due to utility dependencies
- Recommended Epic 1 sequence: 1.0 → 1.1 → 1.2 → 1.3 → **1.4** → 1.5 → 1.6 → **1.7** → 1.8

---

## Testing

### Test File Location

`tests/unit/test_profile_consolidator.py`

### Test Cases

1. **Test profile consolidation with complete data:**
   - Provide full user_profile and university_config
   - Verify all fields populated in ConsolidatedProfile

2. **Test profile consolidation with minimal data:**
   - Provide only required fields
   - Verify optional fields have defaults or "not provided"

3. **Test LLM interest streamlining:**
   - Mock LLM call
   - Verify streamlined_interests generated
   - Test retry on LLM failure

4. **Test education extraction:**
   - Test with multiple education entries
   - Test with empty education
   - Verify formatting

5. **Test skills extraction:**
   - Test with skills list
   - Test with empty skills

6. **Test research experience extraction:**
   - Test with multiple experiences
   - Test with empty experiences

7. **Test markdown generation:**
   - Verify markdown file created
   - Verify all sections present
   - Verify proper formatting

8. **Test checkpoint saving:**
   - Verify checkpoint file created in checkpoints/
   - Verify checkpoint contains all profile data

### Example Test

```python
def test_consolidate_profile_with_full_data():
    # Arrange
    user_profile = {
        "name": "Jane Doe",
        "current_degree": "PhD in CS",
        "target_university": "Stanford",
        "target_department": "Computer Science",
        "research_interests": ["ML", "NLP"],
        "resume_highlights": {
            "education": [{"degree": "MS", "institution": "Berkeley", "year": 2022}],
            "skills": ["Python", "PyTorch"],
            "research_experience": [{"title": "RA", "description": "NLP research", "duration": "2021-2022"}]
        },
        "preferred_graduation_duration": 5.5
    }
    university_config = {
        "university_name": "Stanford",
        "core_website": "https://stanford.edu",
        "directory_link": "https://stanford.edu/directory"
    }

    consolidator = ProfileConsolidator()

    # Act
    profile = consolidator.consolidate(user_profile, university_config)

    # Assert
    assert profile.name == "Jane Doe"
    assert profile.current_degree == "PhD in CS"
    assert len(profile.research_interests) == 2
    assert "MS" in profile.education_background
    assert "Python" in profile.skills_summary
    assert len(profile.key_qualifications) > 0
```

---

## Notes

- **LLM Dependency:** Uses LLM for research interest streamlining (requires llm_helpers from Story 1.4)
- **Checkpoint Format:** Phase 0 uses single JSON file (not batched like other phases)
- **Profile Baseline:** This consolidated profile is THE baseline for all matching operations
- **User Review:** Markdown output allows users to verify profile before proceeding
- **Resumability:** If analysis interrupted, profile loaded from checkpoint (no re-consolidation)

---

## References

- **PRD:** `docs/prd.md` - FR4 (multi-source config), FR6 (consolidated profile document), Epic 1 Story 1.7
- **Architecture:** `docs/architecture.md` - Data Models: User Profile section

---

## Dev Agent Record

### Agent Model Used
- claude-sonnet-4-5-20250929

### Implementation Tasks
- [x] Create ConsolidatedProfile Pydantic model in src/models/profile.py
- [x] Create ProfileConsolidator agent in src/agents/profile_consolidator.py
- [x] Write comprehensive unit tests (18 test cases, 100% coverage)
- [x] Pass all validations (tests, linting, type checking)

### Completion Notes
- Implemented profile consolidator with LLM-based research interest streamlining
- Created ConsolidatedProfile Pydantic model with all required fields
- Integrated with existing utilities: logger, llm_helpers, checkpoint_manager
- Added async/await support for LLM calls
- Implemented markdown generation and checkpoint saving functionality
- All 18 unit tests passing with 100% coverage for new code
- Fixed mypy type checking issues with structlog BindableLogger
- Code passes ruff linting and mypy type checking

### File List
**Created:**
- `src/models/profile.py` - ConsolidatedProfile Pydantic model
- `src/agents/profile_consolidator.py` - ProfileConsolidator agent with consolidation logic
- `tests/unit/test_profile_consolidator.py` - Comprehensive unit tests (18 test cases)

**Modified:**
- None

### Change Log
- 2025-10-06: Initial implementation of Story 1.7
  - Created ConsolidatedProfile model with 13 fields
  - Implemented ProfileConsolidator with 6 private methods for data extraction
  - Added LLM integration for research interest streamlining
  - Implemented markdown generation with proper formatting
  - Implemented checkpoint saving for Phase 0 resumability
  - Created 18 unit tests covering all functionality
  - Added type ignore comments for structlog compatibility

### Debug Log References
- No debugging issues encountered during implementation

---

## QA Results

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is excellent with clean, well-structured code following all project standards. The ProfileConsolidator agent properly consolidates user profile data from multiple sources, uses LLM helpers for research interest streamlining, and generates both markdown output and checkpoint files. All 8 acceptance criteria are fully met with 100% test coverage on new code.

### Refactoring Performed

- **File**: src/agents/profile_consolidator.py
  - **Change**: Replaced deprecated `datetime.utcnow()` with `datetime.now(timezone.utc)`
  - **Why**: `datetime.utcnow()` is deprecated in Python 3.12+ and doesn't include timezone info
  - **How**: Added timezone import and updated ISO timestamp generation for better timezone awareness

- **File**: src/agents/profile_consolidator.py
  - **Change**: Extracted string joins from f-string expressions into variables
  - **Why**: F-strings cannot contain backslashes directly; this improves readability and avoids syntax errors
  - **How**: Created `interests_list` and `qualifications_list` variables before f-string usage

### Compliance Check

- Coding Standards: ✓ Fully compliant after refactoring
- Project Structure: ✓ Files in correct locations (src/agents/, src/models/, tests/unit/)
- Testing Strategy: ✓ 18 comprehensive unit tests with 100% coverage on new code
- All ACs Met: ✓ All 8 acceptance criteria validated with test coverage

### Improvements Checklist

- [x] Fixed deprecated datetime.utcnow() usage (profile_consolidator.py:76)
- [x] Improved f-string readability by extracting string joins (profile_consolidator.py:99, 225-226)
- [x] Verified all tests pass (18/18 passing)
- [x] Verified type checking passes (mypy: success)
- [x] Verified linting passes (ruff: all checks passed)

### Security Review

No security concerns identified. The implementation:
- Uses validated input from JSON schema validation (Story 1.2 dependency)
- No user input processing beyond pre-validated configs
- No file path traversal risks (uses controlled output directory)
- LLM calls properly isolated via llm_helpers module

### Performance Considerations

Implementation is efficient:
- Single LLM call for interest streamlining with retry logic
- Minimal data processing overhead
- Direct file writes (no buffering needed for small outputs)
- Checkpoint format appropriate for Phase 0 (single JSON vs batched JSONL)

**Technical Debt Note**: Coding standards specify async/await for file I/O, but implementation uses synchronous Path.write_text(). This matches the story specification and is acceptable for Phase 0's small file sizes. Consider async I/O if files grow larger in future phases.

### Files Modified During Review

Modified during QA refactoring:
- `src/agents/profile_consolidator.py` - Fixed datetime deprecation and f-string readability

### Requirements Traceability (Given-When-Then)

**AC1: System reads multiple JSON config sources**
- Given: Validated user_profile.json and university_config.json
- When: ProfileConsolidator.consolidate() is called
- Then: All required fields are extracted from both configs
- Tests: test_consolidate_profile_with_full_data, test_consolidate_profile_with_minimal_data

**AC2: Resume content parsed and key highlights extracted**
- Given: Resume highlights in user profile (education, skills, research_experience)
- When: Private extraction methods are called
- Then: Structured summaries are generated for each category
- Tests: test_extract_education_*, test_extract_skills_*, test_extract_experience_*

**AC3: Research interests streamlined using LLM**
- Given: List of research interest statements
- When: _streamline_interests() is called
- Then: LLM generates concise 2-3 sentence summary via call_llm_with_retry
- Tests: test_llm_interest_streamlining, test_llm_failure_propagates

**AC4: Consolidated profile document generated in markdown**
- Given: ConsolidatedProfile Pydantic model
- When: save_markdown() is called
- Then: Formatted markdown file created with all sections
- Tests: test_save_markdown_creates_file, test_markdown_contains_all_sections

**AC5: Profile includes all required sections**
- Given: Complete or minimal user data
- When: Markdown generation occurs
- Then: All sections present (Overview, Research Interests, Background, Qualifications, Configuration, Usage)
- Tests: test_markdown_contains_all_sections

**AC6: Profile saved to output directory**
- Given: Output directory path (default: "output/")
- When: save_markdown() is called
- Then: user_profile.md created in output directory
- Tests: test_save_markdown_creates_file

**AC7: Profile used as input for subsequent operations**
- Given: ConsolidatedProfile with all extracted data
- When: save_checkpoint() is called
- Then: Phase 0 checkpoint saved as JSON for pipeline resumability
- Tests: test_save_checkpoint_creates_file, test_checkpoint_contains_all_fields

**AC8: Profile consolidator module created**
- Given: Story requirements and dependencies
- When: Implementation is complete
- Then: src/agents/profile_consolidator.py exists with ProfileConsolidator class
- Tests: All 18 tests validate the module's functionality

### Gate Status

Gate: PASS → docs/qa/gates/1.7-user-profile-consolidation.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria met, comprehensive test coverage achieved, code quality excellent, and all validations passing. The minor refactoring performed improves code quality without changing functionality.
